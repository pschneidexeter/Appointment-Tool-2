@if(BRT.RenderContext.IsDesign || BRT.RenderContext.IsSecureUrl) {

string action = Request.QueryString["action"];

int id = 0;
if(!String.IsNullOrEmpty(Request.QueryString["id"])){
    id = Int32.Parse(Request.QueryString["id"]);
}

int ms = 0;
if(!String.IsNullOrEmpty(Request.QueryString["ms"])){
    ms = Int32.Parse(Request.QueryString["ms"]);
}

string view = Request.QueryString["view"];
string movegrouping = Request.QueryString["movegrouping"];
string churchstatus = Request.QueryString["churchstatus"];
string churchorperson = Request.QueryString["churchorperson"];
string helpertoprint = Request.QueryString["helpertoprint"];

    switch(action) 
        {
            case "getpeople":
                @getpeople(view);
                break;
            case "getperson":
                @getperson(id);
                break;
            case "churcheswithstatus":
                @churcheswithstatus();
                break;
            case "pendingsimple":
                @pendingsimple();
                break;
            case "currentappointments":
                @currentappointments();
                break;
            case "getchurch":
                @getchurch(id);
                break;
            case "getmetrics":
                @getMetrics(id,churchorperson);
                break;
            case "getappts":
                @getAppts(id,churchorperson);
                break;
            case "getaffecting":
                @getaffecting(id);
                break;
            case "getsalary":
                @getSalary(id,churchorperson);
                break;
            case "print":
                @print(helpertoprint,id);
                break;
            case "cardrows":
                @cardrows();
                break;
            case "getmetricsperson":
                @getMetricsPerson(id);
                break;
            case "makemschanger":
                @makemschanger(id);
                break;
            case "changemovestatus":
                @changemovestatus(id, ms);
                break;
            case "consolepeople":
                @consolepeople();
                break;
        }
}
else {

<div>no access</div>

}

@helper consolepeople(){
    <iframe class="w-100 vh-100" src="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/contacts-appointmenttoolpeople"></iframe>
}

@helper changemovestatus(int id, int ms){

    string msLabel = "";
    bool hasPending = false;
    bool isAffected = false;
    
    EngineAdapter ad = EngineAdapter.Create("Contacts","AppointmentToolPeople"); 
    ad.AddResultField("MoveStatus");
    EngineRecord person = ad.GetRecord(id);
    person["MoveStatus"] = ms;
    person.Update();
    
    // now we need to get the pending appointments, affecting appointments, and move status to send that to the stage status and update on the page
    var adapter = EngineAdapter.Create("Contacts","AppointmentToolPeople");
    adapter.AddResultFields(new[] {"FirstName","MoveStatus"}); // the basic fields
    string[] affectedFields = new string[] {"Appointments.StartDate","Appointments.EndDate","Appointments.Church.PendingAppointments.AppointmentStatus","Appointments.Church.PendingAppointments.AppointmentPosition","Appointments.Church.PendingAppointments.StartDate","Appointments.Church.PendingAppointments.People.FirstName","Appointments.Church.PendingAppointments.People.PreferredName","Appointments.Church.PendingAppointments.People.LastName"};
    string[] pendingFields = new string[] {"PendingAppointments","PendingAppointments.StartDate","PendingAppointments.AppointmentPosition","PendingAppointments.Church.Name","PendingAppointments.Church.MailCity","PendingAppointments.ExtensionMinistryPositions","PendingAppointments.ExtensionMinistry","PendingAppointments.ExtensionMinistryList"};
    
    adapter.AddResultFields(pendingFields);
    adapter.AddResultFields(affectedFields);
    adapter.AddCondition("<Eq FieldId=\"Id\" Value=\"" + id + "\"/>");
    EngineRecordList item =  adapter.GetList(1,1,true);
    
    foreach(EngineRecord record in item){
        msLabel = record.GetFirstCategoryLabel("MoveStatus"); // set their move status label for passing to the function
        if (!record.IsDBNull("PendingAppointments")) { // do they have a pending appt?
            hasPending = true;
        }
        if (!record.IsDBNull("Appointments")) { // I don't love the duplication of the code here but I'm seeing if they are affected.
            foreach (EngineRecord record_appointments in record.GetRecordList("Appointments")) {
                if (!record_appointments.IsDBNull("Church") && (record_appointments.IsDBNull("StartDate") || record_appointments.GetDateTime("StartDate") < DateTime.Now) && (record_appointments.IsDBNull("EndDate") || record_appointments.GetDateTime("EndDate") >= DateTime.Now)) {
                    foreach (EngineRecord record_appointments_church in record_appointments.GetRecordList("Church")) {
                        if (!record_appointments_church.IsDBNull("PendingAppointments")) {
                            isAffected = true;
                        }
                    }
                }
            }
        }
    }
    @DisplayStage(hasPending, msLabel, isAffected, "#stage-" + id.ToString())

}

@helper print(string helpertoprint, int id)
{
    <div hx-get="@BRT.SecureUrl("/at2ajax?action=" + helpertoprint)" hx-trigger="load"></div>
}


@helper makemschanger(int personId){
    @BRT.CategoryList(tableId:"Contacts", viewId:"AppointmentToolPeople", fieldId:"MoveStatus", template: 
    @<div id="ms-@personId" class="bg-primary position-absolute top-0 start-0 rounded p-2" style="z-index:1000;width:250px;">
        @{
            string hs = " _=\"on click hide #ms-" + personId + " then go to #mstd-"  + personId +"\"" ;
            string hs2 = " _=\"on click put my.innerHTML into #currentstatus-" + personId + " then hide #ms-" + personId +"\"";
        }
        <div><a class="text-white" href="#" @BRT.Raw(hs)>cancel</a></div>
        @foreach(EngineRecord c in item) {
            <div><a class="text-white text-decoration-none" href="#" hx-get="@BRT.SecureUrl("/at2ajax?action=changemovestatus&id=" + personId + "&ms=" + c["Id"])" hx-target="#ms-@personId" @BRT.Raw(hs2) >@c["Label"]</a></div>
        }
    </div>
    )
}


@helper getpeople(string view=""){

bool showstage = true;
bool showaffector = true;
bool isAffected = false;

var adapter = EngineAdapter.Create("Contacts","AppointmentToolPeople");
adapter.AddResultFields(new[] {"FirstName","PreferredName","LastName","MoveStatus","ClergyStatus","DateOfBirth","DateStartedInConference","Gender","Ethnicity","KeyCometencies","PeopleRank","PotentialTier","TheologicalPreferences"}); // the basic fields
string[] salaryBaseFields = new string[] {"Salary","Salary.PubDate","Salary.EndDate","Salary.CompensationTags"};
string[] affectedFields = new string[] {"Appointments.StartDate","Appointments.EndDate","Appointments.Church.District","Appointments.Church.Name","Appointments.Church.MailCity","Appointments.Church.PendingAppointments.AppointmentStatus","Appointments.Church.PendingAppointments.AppointmentPosition","Appointments.Church.PendingAppointments.StartDate","Appointments.Church.PendingAppointments.People.FirstName","Appointments.Church.PendingAppointments.People.PreferredName","Appointments.Church.PendingAppointments.People.LastName"};
//string[] affectedFields = new string[] {"Appointments.StartDate","Appointments.EndDate","Appointments.Church.PendingAppointments.AppointmentStatus","Appointments.Church.PendingAppointments.AppointmentPosition","Appointments.Church.PendingAppointments.StartDate","Appointments.Church.PendingAppointments.People.FirstName","Appointments.Church.PendingAppointments.People.PreferredName","Appointments.Church.PendingAppointments.People.LastName"};

string[] pendingFields = new string[] {"PendingAppointments","PendingAppointments.StartDate","PendingAppointments.AppointmentPosition","PendingAppointments.Church.Name","PendingAppointments.Church.MailCity","PendingAppointments.ExtensionMinistryPositions","PendingAppointments.ExtensionMinistry","PendingAppointments.ExtensionMinistryList"};

switch(view) 
{
    case "allaffected":
        adapter.AddResultFields(salaryBaseFields);
        adapter.AddResultFields(SalaryTotalFieldsFullyQualified("people"));
        adapter.AddResultFields(pendingFields);
        adapter.AddResultFields(affectedFields);
        adapter.AddSavedFilter("MoveAll");
        break;
    case "needsmove":
        adapter.AddResultFields(salaryBaseFields);
        adapter.AddResultFields(SalaryTotalFieldsFullyQualified("people"));
        adapter.AddResultFields(pendingFields);
        adapter.AddResultFields(affectedFields);
        adapter.AddSavedFilter("MoveNeedsMove");
        break;
    case "resolved":
        adapter.AddResultFields(salaryBaseFields);
        adapter.AddResultFields(SalaryTotalFieldsFullyQualified("people"));
        adapter.AddResultFields(pendingFields);
        adapter.AddResultFields(affectedFields);
        adapter.AddSavedFilter("MoveBeenMoved");
        break;
    case "affectedunresolved":
        adapter.AddResultFields(salaryBaseFields);
        adapter.AddResultFields(SalaryTotalFieldsFullyQualified("people"));
        adapter.AddResultFields(pendingFields);
        adapter.AddResultFields(affectedFields);
        adapter.AddSavedFilter("UnresolvedAffected");
        break;
    case "affectedresolved":
        adapter.AddResultFields(salaryBaseFields);
        adapter.AddResultFields(SalaryTotalFieldsFullyQualified("people"));
        adapter.AddResultFields(pendingFields);
        adapter.AddResultFields(affectedFields);
        adapter.AddSavedFilter("ResolvedAffected");
        break;
    case "all":
        adapter.AddResultFields(salaryBaseFields);
        adapter.AddResultFields(SalaryTotalFieldsFullyQualified("people"));
        adapter.AddResultFields(pendingFields);
        adapter.AddResultFields(affectedFields);
        adapter.AddSavedFilter("AllPeople");
        break;
    case "noretired":
        adapter.AddResultFields(salaryBaseFields);
        adapter.AddResultFields(SalaryTotalFieldsFullyQualified("people"));
        adapter.AddResultFields(pendingFields);
        adapter.AddResultFields(affectedFields);
        adapter.AddSavedFilter("AllPeopleNoRetired");
        break;
}

EngineRecordList item =  adapter.GetList(1,5000,true);

<div class="text-center mt-1">
    <a href="#" class="btn btn-sm me-2 btn btn-outline-secondary" _="on click toggle .text-nowrap on <td/>">No wrap</a>
    @item.Count.ToString("N0") people

<script type="text/hyperscript">
  def inrange(val, min, max)
     if val >= min and val <= max
       return true
     end
     return false
  end
</script>
@{
string range1 = "on click for e in <tr span[at-salary]/> in <table/> if inrange(e's @at-salary, 1, 50000) then show e.closest('tr') else hide e.closest('tr') end end";
string range2 = "on click for e in <tr span[at-salary]/> in <table/> if inrange(e's @at-salary, 50001, 100000) then show e.closest('tr') else hide e.closest('tr') end end";
string range3 = "on click for e in <tr span[at-salary]/> in <table/> if inrange(e's @at-salary, 100001, 150000) then show e.closest('tr') else hide e.closest('tr') end end";
string range4 = "on click for e in <tr span[at-salary]/> in <table/> if inrange(e's @at-salary, 150001, 900000) then show e.closest('tr') else hide e.closest('tr') end end";
}

<button class="btn btn-sm ms-2 btn btn-outline-secondary" _="@range1">< $50K</button>
<button class="btn btn-sm ms-0 btn btn-outline-secondary" _="@range2">$50-100K</button>
<button class="btn btn-sm ms-0 btn btn-outline-secondary" _="@range3">$100-$150K</button>
<button class="btn btn-sm ms-0 btn btn-outline-secondary" _="@range4">>$150K</button>
<button class="btn btn-sm ms-0 btn btn-outline-secondary" _="on click show <tr/>">All</button>

@*
<select id="salaryrange" class="form-select d-inline w-auto form-select-sm bg-light">
    <option value="">Salary range</option>
    <option value="1" _="on keyup add .d-none to .personrow">< $35K</option>
    <option value="2">$35K to $50K</option>
    <option value="3">$50K to $75K</option>
    <option value="4">$75K to $100K</option>
    <option value="5">$100K to $150K</option>
    <option value="1">> $150K</option>
</select>
*@

</div>


if(item.Count>0){
    
    <script>
    
    
    $(document).ready(function () {
    // Setup - add a text input to each footer cell
    $('#datatable thead tr')
        .clone(true)
        .addClass('filters')
        .appendTo('#datatable thead');
 
    var table = $('#datatable').DataTable({
        "paging":         false,
            "info": false,
            fixedHeader: true,
            "order": [[ 7, "desc" ]],
            dom: 'Bfrtip',
            buttons: [
                'csv', 'excel', 'print'
            ],
        orderCellsTop: true,
        fixedHeader: true,
        initComplete: function () {
            var api = this.api();
 
            // For each column
            api
                .columns()
                .eq(0)
                .each(function (colIdx) {
                    // Set the header cell to contain the input element
                    var cell = $('.filters th').eq(
                        $(api.column(colIdx).header()).index()
                    );
                    var title = $(cell).text();
                    $(cell).html('<input class="fcol" type="text" placeholder="' + title + '"  />');
 
                    // On every keypress in this input
                    $(
                        'input',
                        $('.filters th').eq($(api.column(colIdx).header()).index())
                    )
                        .off('keyup change')
                        .on('keyup change', function (e) {
                            e.stopPropagation();
 
                            // Get the search value
                            $(this).attr('title', $(this).val());
                            var regexr = '({search})'; //$(this).parents('th').find('select').val();
 
                            var cursorPosition = this.selectionStart;
                            // Search the column for that value
                            api
                                .column(colIdx)
                                .search(
                                    this.value != ''
                                        ? regexr.replace('{search}', '(((' + this.value + ')))')
                                        : '',
                                    this.value != '',
                                    this.value == ''
                                )
                                .draw();
 
                            $(this)
                                .focus()[0]
                                .setSelectionRange(cursorPosition, cursorPosition);
                        });
                });
        },
    });
});
    
    
    </script>
    
    <table class="cell-border mt-3" id="datatable">
        <thead>
            <tr>
            
            <th>Name</th><th>Rel</th><th>Mv sts</th>
            <th>Stage</th>
            <th>Affectings</th>
            <th>Pendings</th>
            
            <th>Age</th>
            <th>Gdr</th>
            <th>Eth</th>
            <th>YUA</th>
            <th>Tot sal</th>
            <th>Hou</th>
            <th>Dist</th>
            <th>Comps</th>
            <th>Perf</th>
            <th>Theo</th>
            
            
            </tr>
        </thead>
<tbody>

  @foreach(EngineRecord record in item) {
  isAffected=false;
    <tr class="personrow">
      <td class="position-relative" data-sort="@if(!record.IsDBNull("LastName")){@record["LastName"]}@if(!record.IsDBNull("FirstName")) {@record["FirstName"]}">
          <div class="text-nowrap">
            <small>
                <a data-bs-toggle="tooltip" title="Make a new appointment for this person" href="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/contacts-appointmenttoolpeople#page=1,@record.Id,PendingAppointments:new" target="_blank" class="text-muted editlink"><i class="bi bi-plus-circle"></i></a>
            </small>
              
            <a data-bs-toggle="offcanvas" data-bs-target="#snapshotmodal" 
                href="#"
                hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record.Id)" 
                hx-target="#snapbody" class="text-dark"  hx-indicator="#modalindicator"
            >
            @if(!record.IsDBNull("PreferredName")) {
              <span> @record["PreferredName"]</span>
            }
            else if(!record.IsDBNull("FirstName")) {
              <span>@record["FirstName"]</span>
            }
            @if(!record.IsDBNull("LastName")) {
               <span> @record["LastName"]</span>
            }
            
            </div>
            
        
        </td>
        <td>
        @if(!record.IsDBNull("ClergyStatus")) {
          <span>@record.GetFirstCategoryAbbrev("ClergyStatus")</span>
        }
        </td>
        <td class="position-relative" id="mstd-@record.Id">
        @if(!record.IsDBNull("MoveStatus")) {
            <small>
            <a href="#" hx-get="@BRT.SecureUrl("/at2ajax?action=makemschanger&id=" + record.Id)" hx-swap="afterend" class="text-dark" id="currentstatus-@record.Id">
                @record.GetFirstCategoryLabel("MoveStatus")
            </a>
            </small>
        }
        else {
            <small>
            <a href="#" hx-get="@BRT.SecureUrl("/at2ajax?action=makemschanger&id=" + record.Id)" hx-swap="afterend" class="text-dark" id="currentstatus-@record.Id">
                <span class="text-muted">set</span>
            </a></small>
        }
        </td>
        <td id="stage-@record.Id">
            @if (!record.IsDBNull("PendingAppointments")) {
                if (!record.IsDBNull("MoveStatus")){
                    @DisplayStage(true, record.GetFirstCategoryLabel("MoveStatus"), isAffected)
                }
                else{
                    @DisplayStage(true, "", isAffected)
                }
            }
            else {
                
                if(!record.IsDBNull("MoveStatus")){
                    @DisplayStage(false,record.GetFirstCategoryLabel("MoveStatus"),isAffected)   
                }
                else {
                    @DisplayStage(false,"",isAffected)
                }
            }
        </td>
        <td>
            <small class="text-muted">
                @if (!record.IsDBNull("Appointments")) {
                            foreach (EngineRecord record_appointments in record.GetRecordList("Appointments")) {
                                @* Church (appt tool) *@
                                if (!record_appointments.IsDBNull("Church") && (record_appointments.IsDBNull("StartDate") || record_appointments.GetDateTime("StartDate") < DateTime.Now) && (record_appointments.IsDBNull("EndDate") || record_appointments.GetDateTime("EndDate") >= DateTime.Now)) {
                                    
                                    <span>
                                        @foreach (EngineRecord record_appointments_church in record_appointments.GetRecordList("Church")) {
                                            <span>
                                                @* Incoming Projected Appointments *@
                                                @if (!record_appointments_church.IsDBNull("PendingAppointments")) {
                                                    isAffected = true;
                                                    <span>
                                                        @foreach (EngineRecord record_appointments_church_pendingappointments in record_appointments_church.GetRecordList("PendingAppointments")) {
                                                            <div><span class="bg-warning bg-opacity-10 me-2">
                                                                <a data-bs-toggle="tooltip" title="Edit this pending appointment" href="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/content-appointmenttoolpendingappointments#page=1,@record_appointments_church_pendingappointments.Id" target="_blank" class="text-muted">
                                                                <i class="bi bi-pencil-square"></i> Affected by:
                                                                </a>
                                                                
                                                                @* Appointment Position *@
                                                                @if (!record_appointments_church_pendingappointments.IsDBNull("AppointmentPosition")) {
                                                                    <span>
                                                                        @foreach (CategoryFieldItem cat in record_appointments_church_pendingappointments.GetCategory("AppointmentPosition")) {
                                                                            <span>
                                                                                @cat.Label
                                                                            </span>
                                                                        }
                                                                    </span>
                                                                }

                                                                @* Start *@
                                                                @if (!record_appointments_church_pendingappointments.IsDBNull("StartDate")) {
                                                                    <span>
                                                                        @record_appointments_church_pendingappointments.GetDateTime("StartDate").ToShortDateString()
                                                                    </span>
                                                                }

                                                                @* People *@
                                                                @if (!record_appointments_church_pendingappointments.IsDBNull("People")) {
                                                                    <span>
                                                                        @foreach (EngineRecord record_appointments_church_pendingappointments_people in record_appointments_church_pendingappointments.GetRecordList("People")) {
                                                                            <span>
                                                                                
                                                                                @if (!record_appointments_church_pendingappointments_people.IsDBNull("PreferredName")) {
                                                                                    <span>
                                                                                        @record_appointments_church_pendingappointments_people["PreferredName"]
                                                                                    </span>
                                                                                }
                                                                                else if (!record_appointments_church_pendingappointments_people.IsDBNull("FirstName")) {
                                                                                    <span>
                                                                                        @record_appointments_church_pendingappointments_people["FirstName"]
                                                                                    </span>
                                                                                }

                                                                                @* Last Name *@
                                                                                @if (!record_appointments_church_pendingappointments_people.IsDBNull("LastName")) {
                                                                                    <span>
                                                                                        @record_appointments_church_pendingappointments_people["LastName"]
                                                                                    </span>
                                                                                }
                                                                            </span>
                                                                    }
                                                                    </span>
                                                                }
                                                            </span></div>
                                                    }
                                                    </span>
                                                }
                                            </span>
                                    }
                                    </span>
                                }
                            }
                        }
                </small>
        </td>
        <td>
            @if (!record.IsDBNull("PendingAppointments")) {
                foreach(EngineRecord appointment in record.GetRecordList("PendingAppointments")) {
                    <div><span class="bg-success bg-opacity-10">
                        <small class="text-muted">
                            <a data-bs-toggle="tooltip" title="Edit this pending appointment" href="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/content-appointmenttoolpendingappointments#page=1,@appointment.Id" target="_blank" class="text-muted">
                            <i class="bi bi-pencil-square"></i> moving</a>
                            to </small>
                        
    
                     @if (!appointment.IsDBNull("Church")) {
                            <small class="text-muted"> 
                                @foreach (EngineRecord record_appointments_church in appointment.GetRecordList("Church")) {
                                    <a data-bs-toggle="offcanvas" data-bs-target="#snapshotmodal" href="#"
                                    hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record_appointments_church.Id)" hx-target="#snapbody" class="text-muted" hx-indicator="#modalindicator">
                                        
                                        @if (!record_appointments_church.IsDBNull("Name")) {
                                            <span>
                                                <span>@record_appointments_church["Name"]</span>
                                                @if (!record_appointments_church.IsDBNull("MailCity")) {
                                                    <span>
                                                         - @record_appointments_church["MailCity"]
                                                    </span>
                                                }
                                                
                                            </span>
                                        }
    
                                        
                                        
                                    </a>
                            }
                            </small>
                        }
                   
                        @if (!appointment.IsDBNull("ExtensionMinistryPositions")) {
                            <small class="text-muted">
                                @foreach (CategoryFieldItem cat in appointment.GetCategory("ExtensionMinistryPositions")) {
                                    <span>
                                        @cat.Label
                                    </span>
                                }
                            </small>
                        }
                      
                        @if (!appointment.IsDBNull("ExtensionMinistry")) {
                            <small class="text-muted">
                                @appointment["ExtensionMinistry"]
                            </small>
                        }
    
                        
                        @if (!appointment.IsDBNull("ExtensionMinistryList")) {
                            <small class="text-muted">
                                extension ministry
                            </small>
                        }
                        
                        
                        
                    </span></div>
                }
            }
        </td>
        
        <td>
        @if(!record.IsDBNull("DateOfBirth")) {
           <div>@Math.Floor((DateTime.Now - record.GetDateTime("DateOfBirth")).TotalDays / 365)</div>
        }
        </td>
        <td>
        @if(!record.IsDBNull("Gender")) {
          <span>@record.GetFirstCategoryAbbrev("Gender")</span>
        }
        </td>
        <td>
        @if(!record.IsDBNull("Ethnicity")) {
          <span>@record.GetFirstCategoryLabel("Ethnicity")</span>
        }
        </td>
        <td>
        @if(!record.IsDBNull("DateStartedInConference")) {
           <div>@Math.Floor((DateTime.Now - record.GetDateTime("DateStartedInConference")).TotalDays / 365)</div>
        }
        </td>
        <td class="bg-success bg-opacity-10 salary-field total-salary">
            @if(!record.IsDBNull("Salary")) {
                @BRT.Raw(GetTotalSalary(record.GetRecordList("Salary")))
            }
            else
            {
                <span at-salary="0">$0</span>
            }
        </td>
        <td class="bg-success bg-opacity-10 salary-field">
            @{
                string CompensationTags="";
                if(!record.IsDBNull("Salary")) {
                    foreach(EngineRecord record_salary in record.GetRecordList("Salary")) {
                        if (record_salary.HasField("CompensationTags") && !record_salary.IsDBNull("CompensationTags")) {
                            foreach (CategoryFieldItem cat in record_salary.GetCategory("CompensationTags")) {
                                if(cat.Label=="Has Parsonage"){
                                    CompensationTags="P";
                                }
                                else if (cat.Label=="Housing Allowance"){
                                    CompensationTags="HA";
                                }
                                else{
                                    CompensationTags=cat.Label;
                                }
                            }
                        }
                    }
                }
            }
            @CompensationTags
        </td>
        <td>
            @if (!record.IsDBNull("Appointments")) {
                string onedist="";
                foreach (EngineRecord record_appointments in record.GetRecordList("Appointments")) {
                    if (!record_appointments.IsDBNull("Church") && (record_appointments.IsDBNull("StartDate") || record_appointments.GetDateTime("StartDate") < DateTime.Now) && (record_appointments.IsDBNull("EndDate") || record_appointments.GetDateTime("EndDate") >= DateTime.Now)) {
                        
                        foreach (EngineRecord record_appointments_church in record_appointments.GetRecordList("Church")) {
                            if (!record_appointments_church.IsDBNull("District")) {
                               foreach (EngineRecord district in record_appointments_church.GetRecordList("District")) { 
                                    onedist = district.GetString("Name");
                               }
                            }
                        }
                    }
                }
                @onedist
            }
        </td>
        
        
        <td>
            @if (!record.IsDBNull("KeyCometencies")) {
                foreach (CategoryFieldItem cat in record.GetCategory("KeyCometencies")) {
                    <small class="px-1 border rounded d-inline-block">
                        @cat.Label
                    </small>
                }
            }
        </td>
        
        <td>
            @if (!record.IsDBNull("PeopleRank")) {
                foreach (CategoryFieldItem cat in record.GetCategory("PeopleRank")) {
                    <small class="border rounded px-1 d-inline-block">
                        <small class="text-muted">rank:</small> @cat.Label
                    </small>
                }
            }
            @if (!record.IsDBNull("PotentialTier")) {
                foreach (CategoryFieldItem cat in record.GetCategory("PotentialTier")) {
                    <small class="border rounded px-1 d-inline-block">
                        <small class="text-muted">potential:</small> @cat.Label
                    </small>
                }
            }
            
        </td>
        <td>
            @if (!record.IsDBNull("TheologicalPreferences")) {
                foreach (CategoryFieldItem cat in record.GetCategory("TheologicalPreferences")) {
                    <small class="border rounded px-1 d-inline-block">
                        @cat.Label
                    </small>
                }
            }
        </td>
    </tr>
    
    
  }
</tbody>
</table>






}

}

@helper DisplayStage(bool hasPending, string moveStatus, bool isAffected, string putInto = ""){
    if(!String.IsNullOrEmpty(putInto)){
        @BRT.Raw("<span _=\"init put me into " + putInto + "\">")
    }
    if(hasPending){ // if you have a pending appointment, you are all set no matter what
        <small class="text-white bg-success px-1 rounded d-block"><i class="bi bi-check-circle"></i> appointed</small>
    }
    else{ // if you are affeced BUT you have a move status set to "remain" or "appointment set" then you are also resolved
        if(isAffected && !String.IsNullOrEmpty(moveStatus) && moveStatus=="Remain" || moveStatus=="Appointment Set"){
            <small class="text-white bg-success px-1 rounded d-block"><i class="text-warning bi bi-asterisk"></i> resolved: @moveStatus</small>
        }
        else if(isAffected){ // if you're affected, then you gotta move
            <small class="text-white bg-danger px-1 rounded d-block">move: affected</small>
        }
        else{
            if(String.IsNullOrEmpty(moveStatus)){
                <small class="bg-light px-1 rounded d-block">no move status</small>
            }
            else if(moveStatus=="Could" || moveStatus=="Should" || moveStatus=="Must" || moveStatus=="Retiring") {
                <small class="text-white bg-danger px-1 rounded d-block">move: @moveStatus</small>
            }
            else if(moveStatus=="Remain" || moveStatus=="Appointment Set") {
                <small class="text-white bg-success px-1 rounded d-block">set: @moveStatus</small>
            }
            else if(moveStatus=="No Appointment") {
                <small class="bg-warning px-1 rounded d-block">set to No Appointment</small>
            }
        }
    }
    @BRT.Raw("</span>")
}




@helper churcheswithstatus(string show="all")
{

    var adapter = EngineAdapter.Create("Contacts","AppointmentToolChurches");
    adapter.AddResultFields(new[] {"Name","MailCity","District.Name","ClergyServing.People.FirstName","ClergyServing.People.PreferredName","ClergyServing.People.LastName"}); // the basic fields
    adapter.AddResultFields(new[] {"ClergyServing.People.PendingAppointments.Church.Name","ClergyServing.People.PendingAppointments.Church.MailCity","ClergyServing.People.PendingAppointments.ExtensionMinistryPositions","ClergyServing.People.PendingAppointments.ExtensionMinistry","ClergyServing.People.PendingAppointments.ExtensionMinistryList","PendingAppointments.People.FirstName","PendingAppointments.People.PreferredName","PendingAppointments.People.LastName"}); // pending and more
    adapter.AddResultFields(new[] {"CompensationInfo","CompensationInfo.PubDate","CompensationInfo.EndDate"});
    adapter.AddResultFields(SalaryTotalFieldsFullyQualified("churches"));
    adapter.AddSavedFilter("ExcludeMerged");
    adapter.AddSavedFilter("ExcludeClosed");
    EngineRecordList item =  adapter.GetList(1,5000,true);
    <div class="text-center mt-1">@item.Count.ToString("N0") churches 
        
        
        <div class="btn-group btn-group-sm" role="group" aria-label="filtering">
          <input type="checkbox" class="btn-check" id="btncheck1" autocomplete="off" _="on click toggle .d-none on <tr:not(.openchurch)/>">
          <label class="btn btn-outline-danger" for="btncheck1">Open</label>
        
          <input type="checkbox" class="btn-check" id="btncheck2" autocomplete="off" _="on click toggle the *display of .openchurch then toggle .visible on .openchurch">
          <label class="btn btn-outline-success" for="btncheck2">Resolved</label>
        </div>
    </div>
    if (item.Count > 0) {
    
 <script>
    
    
    $(document).ready(function () {
    // Setup - add a text input to each footer cell
    $('#datatable thead tr')
        .clone(true)
        .addClass('filters')
        .appendTo('#datatable thead');
 
    var table = $('#datatable').DataTable({
        "paging":         false,
            "info": false,
            "order": [[ 0, "asc" ]],
            dom: 'Bfrtip',
            buttons: [
                'csv', 'excel', 'print'
            ],
        orderCellsTop: true,
        fixedHeader: true,
        initComplete: function () {
            var api = this.api();
 
            // For each column
            api
                .columns()
                .eq(0)
                .each(function (colIdx) {
                    // Set the header cell to contain the input element
                    var cell = $('.filters th').eq(
                        $(api.column(colIdx).header()).index()
                    );
                    var title = $(cell).text();
                    $(cell).html('<input class="fcol" type="text" placeholder="' + title + '"  />');
 
                    // On every keypress in this input
                    $(
                        'input',
                        $('.filters th').eq($(api.column(colIdx).header()).index())
                    )
                        .off('keyup change')
                        .on('keyup change', function (e) {
                            e.stopPropagation();
 
                            // Get the search value
                            $(this).attr('title', $(this).val());
                            var regexr = '({search})'; //$(this).parents('th').find('select').val();
 
                            var cursorPosition = this.selectionStart;
                            // Search the column for that value
                            api
                                .column(colIdx)
                                .search(
                                    this.value != ''
                                        ? regexr.replace('{search}', '(((' + this.value + ')))')
                                        : '',
                                    this.value != '',
                                    this.value == ''
                                )
                                .draw();
 
                            $(this)
                                .focus()[0]
                                .setSelectionRange(cursorPosition, cursorPosition);
                        });
                });
        },
    });
});
    
    
    </script>

    
<table class="cell-border mt-3" id="datatable">
    <thead>
        <tr>
            
            <th>Church</th>
            <th>District</th>
            <th>Leaving</th>
            <th>Coming</th>
            <th>Status</th>
            <th>Tot sal</th>
        </tr>
    </thead>
    <tbody>
    
    
    @{
    int leaving = 0;
    int coming = 0;
}
        @foreach (EngineRecord record in item) {
        leaving = 0;
        coming = 0;
        
        <tr id="ch-@record.Id" class="churchrow visible">
            <td>
            <a data-bs-toggle="offcanvas" data-bs-target="#snapshotmodal" 
                href="#"
                hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record.Id)" 
                class="text-dark"
                hx-target="#snapbody" hx-indicator="#modalindicator"
                >
            @* Church SHORT Name *@
            @if (!record.IsDBNull("Name")) {
                <span>
                    @record["Name"]
                </span>
            }

            @* Mail City *@
            @if (!record.IsDBNull("MailCity")) {
                <span>
                    -  @record["MailCity"]
                </span>
            }
            </a>
            </td>
            <td>

            @* District *@
            @if (!record.IsDBNull("District")) {
                <span>
                    @foreach (EngineRecord record_district in record.GetRecordList("District")) {
                        <span>
                            @* District Name *@
                            @if (!record_district.IsDBNull("Name")) {
                                @BRT.Raw("<span _=\"on load add .d-" + record_district.Id + " to the closest parent <tr/>\">")
                                    @record_district["Name"]
                                @BRT.Raw("</span>")
                            }
                        </span>
                }
                </span>
            }
            
            </td>
            <td>
            @* Clergy currently serving *@
            @if (!record.IsDBNull("ClergyServing")) {
                <span>
                    @foreach (EngineRecord record_clergyserving in record.GetRecordList("ClergyServing")) {
                        <div><small class="text-muted">
                            @* Person (appt tool) *@
                            @if (!record_clergyserving.IsDBNull("People")) {
                                <span>
                                    @foreach (EngineRecord record_clergyserving_people in record_clergyserving.GetRecordList("People")) {
                                        

                                            @* Pending Appointments *@
                                            if (!record_clergyserving_people.IsDBNull("PendingAppointments")) {
                                                
                                                
                                            leaving +=1;
                                            <i class="bi bi-arrow-right"></i> 
                                                @* First Name *@
                                                <a data-bs-toggle="offcanvas" data-bs-target="#snapshotmodal" href="#"
                                                hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_clergyserving_people.Id)" hx-target="#snapbody" class="text-muted"  hx-indicator="#modalindicator">
                                                @if (!record_clergyserving_people.IsDBNull("PreferredName")) {
                                                    <span>
                                                        @record_clergyserving_people["PreferredName"]
                                                    </span>
                                                }
                                                else if (!record_clergyserving_people.IsDBNull("FirstName")) {
                                                    <span>
                                                        @record_clergyserving_people["FirstName"]
                                                    </span>
                                                }
                                                
    
                                                @* Last Name *@
                                                @if (!record_clergyserving_people.IsDBNull("LastName")) {
                                                    <span>
                                                        @record_clergyserving_people["LastName"]
                                                    </span>
                                                }
                                                </a>
                                                <span> is going to </span>
                                            
                                            
                                            
                                                int numChurchesBeingAppointedTo = 0;
                                                <span>
                                                    @foreach (EngineRecord record_clergyserving_people_pendingappointments in record_clergyserving_people.GetRecordList("PendingAppointments")) {
                                                        numChurchesBeingAppointedTo+=1;
                                                        if(numChurchesBeingAppointedTo > 1){
                                                            <small><br/>and </small>
                                                        }
                                                        <span>
                                                            @* Church *@
                                                            @if (!record_clergyserving_people_pendingappointments.IsDBNull("Church")) {
                                                                <span>
                                                                    @foreach (EngineRecord record_clergyserving_people_pendingappointments_church in record_clergyserving_people_pendingappointments.GetRecordList("Church")) {
                                                                        <a data-bs-toggle="offcanvas" data-bs-target="#snapshotmodal" 
                                                                        href="#"
                                                                        hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record_clergyserving_people_pendingappointments_church.Id)" 
                                                                        class="text-muted"
                                                                        hx-target="#snapbody" hx-indicator="#modalindicator"
                                                                        >
                                                                            @* Church SHORT Name *@
                                                                            @if (!record_clergyserving_people_pendingappointments_church.IsDBNull("Name")) {
                                                                                <span>
                                                                                    @record_clergyserving_people_pendingappointments_church.GetString("Name").Summarize(25)
                                                                                </span>
                                                                            }

                                                                            @* Mail City *@
                                                                            @if (!record_clergyserving_people_pendingappointments_church.IsDBNull("MailCity")) {
                                                                                <span>
                                                                                     - @record_clergyserving_people_pendingappointments_church["MailCity"]
                                                                                </span>
                                                                            }
                                                                        </a>
                                                                }
                                                                </span>
                                                            }
                                                            
                                                            
                                                            @if (!record_clergyserving_people_pendingappointments.IsDBNull("ExtensionMinistryPositions")) {
                                                                <small class="text-muted">
                                                                    @foreach (CategoryFieldItem cat in record_clergyserving_people_pendingappointments.GetCategory("ExtensionMinistryPositions")) {
                                                                        <span>
                                                                            @cat.Label
                                                                        </span>
                                                                    }
                                                                </small>
                                                            }
                                        
                                                          
                                                            @if (!record_clergyserving_people_pendingappointments.IsDBNull("ExtensionMinistry")) {
                                                                <small class="text-muted">
                                                                    @record_clergyserving_people_pendingappointments["ExtensionMinistry"]
                                                                </small>
                                                            }
                                        
                                                            
                                                            @if (!record_clergyserving_people_pendingappointments.IsDBNull("ExtensionMinistryList")) {
                                                                <small class="text-muted">
                                                                    extension ministry
                                                                </small>
                                                            }
                                                            
                                                        </span>
                                                }
                                                </span>
                                            }
                                            
                                            
                                        
                                }
                                </span>
                            }
                        </small></div>
                }
                </span>
            }
            </td>
            <td>
            @* Incoming Projected Appointments *@
            @if (!record.IsDBNull("PendingAppointments")) {
                
                
                <small class="text-muted">
                    @foreach (EngineRecord record_pendingappointments in record.GetRecordList("PendingAppointments")) {
                        <div>
                            @* People *@
                            @if (!record_pendingappointments.IsDBNull("People")) {
                                coming +=1;
                                <span><i class="bi bi-arrow-left"></i> 
                                    @foreach (EngineRecord record_pendingappointments_people in record_pendingappointments.GetRecordList("People")) {
                                        <a data-bs-toggle="offcanvas" data-bs-target="#snapshotmodal" href="#"
                                            hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_pendingappointments_people.Id)" hx-target="#snapbody" class="text-muted" hx-indicator="#modalindicator">
                                            @* First Name *@
                                            @if (!record_pendingappointments_people.IsDBNull("PreferredName")) {
                                                <span>
                                                    @record_pendingappointments_people["PreferredName"]
                                                </span>
                                            }
                                            else if (!record_pendingappointments_people.IsDBNull("FirstName")) {
                                                <span>
                                                    @record_pendingappointments_people["FirstName"]
                                                </span>
                                            }

                                            @* Last Name *@
                                            @if (!record_pendingappointments_people.IsDBNull("LastName")) {
                                                <span>
                                                    @record_pendingappointments_people["LastName"]
                                                </span>
                                            }
                                        </a>
                                            <span class="text-muted"> is coming</span>
                                }
                                
                                </span>
                            }
                        </div>
                }
                </small>
                
            }
            
            
            </td>
            <td>
                @if(leaving==coming || leaving < coming){
                    <span _="on load add .resolvedchurch to the closest parent <tr/>"></span>
                }
                else {
                    <span _="on load add .openchurch to the closest parent <tr/>"></span>
                }
                <small class="text-white">
                    <span class="@(leaving==coming || leaving<coming?" px-1 bg-success rounded d-inline-block text-nowrap":"px-1 bg-danger rounded d-inline-block text-nowrap")">@leaving leaving, @coming coming</span>
                </small>
            </td>
            
            <td class="bg-success bg-opacity-10 salary-field">
                @if(!record.IsDBNull("CompensationInfo")) {
                    @BRT.Raw(GetTotalSalary(record.GetRecordList("CompensationInfo")))
                }
            </td>
            
        </tr>
        }                          @* END: foreach (EngineRecord record in item) *@
</tbody>
</table>
    }                              @* END: if (item.Count > 0) *@


}



@*
@helper getperson(int id, string churchorperson = "person"){
   <div hx-get="@BRT.SecureUrl("/tempgetter?action=getperson&churchorperson=" + churchorperson + "&id=" + id)" hx-trigger="load"></div> 
}
*@

@helper getperson(int id, string churchorperson = "person"){
    
        var adapter = EngineAdapter.Create("Contacts","AppointmentToolPeople");
        adapter.AddResultFields(new[] {"PrimaryImage","FirstName","PreferredName","LastName","MoveStatusPerson","MoveStatusChurch","MoveStatus","MoveStatusNotes","AppointmentFit","PeopleRank",
        "PotentialTier","KeyCometencies","ClergySpouseTags","TheologicalPreferences","ClergyStatus","MaritalStatus","TrainingCertLog.TrainingType","TrainingCertLog.NamedClass",
        "TrainingCertLog.CompletionStatus","TrainingCertLog.PubDate","TrainingCertLog.ExpiresOn","TrainingCertLog.TrainingFile","ChildrenInfo","Spouse",
        "ClergyHasThisSpouse.FirstName","ClergyHasThisSpouse.LastName","DateStartedInConference","DateOfBirth","Ethnicity","Gender","HomeChurch.District.Name",
        "CurrentConferenceDropDown","ConfidentialNote","GCFAId","AppointmentToolFiles","Registrations.EventName","Registrations.RegisterDate","Registrations.AccessKey"}); // the basic fields
        
        adapter.AddResultFields(new[] {"Salary","Salary.PubDate","Salary.EndDate","Salary.CompensationTags"}); // salary fields
        adapter.AddResultFields(SalaryTotalFieldsFullyQualified("people"));
        adapter.AddCondition("<Eq FieldId=\"Id\" Value=\"" + id + "\"/>");
        
        EngineRecordList item =  adapter.GetList(1,1,true);
        
        <div>
            @if (item.Count > 0) {
                @*<a href="#" hx-get="@BRT.SecureUrl("/at2ajax?action=print&helpertoprint=getperson&id=" + id)" hx-target="#renderdiv" hx-indicator="#indicator">print</a>*@
                    foreach (EngineRecord record in item) {
                        <h4 class="p-2 bg-white d-flex justify-content-between align-items-center border" id="modalhead">
                            <span>
                                @if(!record.IsDBNull("FirstName")) {
                                  <span>@record["FirstName"]</span>
                                }
                                @if(!record.IsDBNull("PreferredName")) {
                                  <span> (@record["PreferredName"])</span>
                                }
                                @if(!record.IsDBNull("LastName")) {
                                   <span> @record["LastName"]</span>
                                }
                            </span>
                            <span style="font-size: 60% !important;">
                                <a href="#" class="d-none btn btn-primary btn-sm" _="on click add .d-none to me" id="back" hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + Request.QueryString["id"])" 
                                    hx-target="#snapbody" hx-indicator="#modalindicator"><i class="bi bi-arrow-left"></i> Back
                                    @if (!record.IsDBNull("FirstName")) {
                                    <span>to @record["FirstName"]</span>
                                    }
                                </a>
                                
                                <a href="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/contacts-appointmenttoolpeople#page=1,@id,PendingAppointments:new" 
                                target="_blank" class="btn btn-secondary btn-sm">
                                    Appoint or view in console
                                </a>
                                @*
                                <a href="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/contacts-appointmenttoolpeople#page=1,@id" 
                                    target="_blank" class="btn btn-sm btn-secondary" >
                                    <!--Jump to BR Console-->
                                    View 
                                    @if (!record.IsDBNull("FirstName")) {
                                        <span>@record["FirstName"]</span>
                                    }
                                    in the Console
                                    </a>
                                
                                <a href="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/contacts-appointmenttoolpeople#page=1,@id" 
                                    target="_blank">
                                    View 
                                    @if (!record.IsDBNull("FirstName")) {
                                        <span>@record["FirstName"]</span>
                                    }
                                    in the Console
                                </a>
                                *@
                            </span>
                        </h4>
                        
     
                        
                        <div id="modalmeat" class="mt-3">
                            <div class="row mb-3">
                                @{string secondcolumn = "col-xl-12 ";}
                                @if (!record.IsDBNull("PrimaryImage") && record.GetFiles("PrimaryImage").Count==1) {
                                    secondcolumn = "col-xl-9 ";
                                    <div class="col-xl-3 col-12">
                                    @foreach (FileFieldItem file in record.GetFiles("PrimaryImage")) {
                                        <div>
                                            @if (file.ContentType.StartsWith("image/")) {
                                                <a href="@(file.Url)" target="_blank"><img src="@(file.Url)?width=246&height=246&mode=crop" class="p-2 border img-fluid rounded"/></a>
                                            }
                                        </div>
                                    }
                                    </div>
                                }
                                <div class="@(secondcolumn + "col-12 table-responsive")">
                                    <table class="table table-bordered table-sm">
                                        @if(record.HasField("GCFAId") && !record.IsDBNull("GCFAId")){
                                            <tr>
                                                <td>
                                                    <b>GCFA Id</b>
                                                </td>
                                                <td>
                                                    @record.GetString("GCFAId");
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("ClergyStatus") && !record.IsDBNull("ClergyStatus")) {
                                            <tr>
                                                <td>
                                                    <b>Clergy Status</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("ClergyStatus")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if(!record.IsDBNull("Salary")) {
                                            <tr>
                                                <td>
                                                    <b>Total comp</b>
                                                </td>
                                                <td>
                                                    
                                                    @BRT.Raw(GetTotalSalary(record.GetRecordList("Salary")))
                                                    
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("DateStartedInConference") && !record.IsDBNull("DateStartedInConference")) {
                                            <tr>
                                                <td>
                                                    <b>Date Started In Conference</b>
                                                </td>
                                                <td>
                                                    @record.GetDateTime("DateStartedInConference").ToShortDateString()
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <b>Years in Conference</b>
                                                </td>
                                                <td>
                                                    @{
                                                        var today = DateTime.Today;
                                                        var yearStarted = record.GetDateTime("DateStartedInConference");
                                                        var yic = today.Year - yearStarted.Year;
                                                        if (yearStarted.Date > today.AddYears(-yic)) {
                                                            yic--;
                                                        }
                                                    }
                                                    <span>@yic</span>
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("DateOfBirth") && !record.IsDBNull("DateOfBirth")) {
                                            <tr>
                                                <td>
                                                    <b>Age</b>
                                                </td>
                                                <td>
                                                    @{
                                                        var today = DateTime.Today;
                                                        var birthdate = record.GetDateTime("DateOfBirth");
                                                        var age = today.Year - birthdate.Year;
                                                        if (birthdate.Date > today.AddYears(-age)) {
                                                            age--;
                                                        }
                                                    }
                                                    <span>@age</span>
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("Ethnicity") && !record.IsDBNull("Ethnicity")) {
                                            <tr>
                                                <td>
                                                    <b>Ethnicity</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("Ethnicity")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("Gender") && !record.IsDBNull("Gender")) {
                                            <tr>
                                                <td>
                                                    <b>Gender</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("Gender")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("ClergySpouseTags") && !record.IsDBNull("ClergySpouseTags")) {
                                            <tr>
                                                <td>
                                                    <b>Clergy Spouse Tags</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("ClergySpouseTags")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("MaritalStatus") && !record.IsDBNull("MaritalStatus")) {
                                            <tr>
                                                <td>
                                                    <b>Marital Status</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("MaritalStatus")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("Spouse") && !record.IsDBNull("Spouse")) {
                                            <tr>
                                                <td>
                                                    <b>Spouse</b>
                                                </td>
                                                <td>
                                                    @record["Spouse"]
                                                </td>
                                            </tr>
                                        } else if (record.HasField("ClergyHasThisSpouse") && !record.IsDBNull("ClergyHasThisSpouse") && record.GetRecordList("ClergyHasThisSpouse").Count > 0) {
                                            <tr>
                                                <td>
                                                    <b>Spouse</b>
                                                </td>
                                                <td>
                                                    @foreach (EngineRecord record_people in record.GetRecordList("ClergyHasThisSpouse")) {
                                                        <a _="on click remove .d-none from #back" href="#" class="text-dark"
                                                            hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_people.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator"
                                                        >
                                                            @if (record_people.HasField("PreferredName") && !record_people.IsDBNull("PreferredName")) {
                                                                <span>@record_people["PreferredName"]</span>
                                                            } else if (record_people.HasField("FirstName") && !record_people.IsDBNull("FirstName")) {
                                                                <span>@record_people["FirstName"]</span>
                                                            }
                                                            @if (record_people.HasField("LastName") && !record_people.IsDBNull("LastName")) {
                                                                <span>@record_people["LastName"]</span>
                                                            }
                                                        </a>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("ChildrenInfo") && !record.IsDBNull("ChildrenInfo")) {
                                            <tr>
                                                <td>
                                                    <b>Children Info</b>
                                                </td>
                                                <td>
                                                    @record["ChildrenInfo"]
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("HomeChurch") && !record.IsDBNull("HomeChurch") && record.GetRecordList("HomeChurch").Count > 0) {
                                            foreach (EngineRecord record_homechurch in record.GetRecordList("HomeChurch")) {
                                                if (record_homechurch.HasField("District") && !record_homechurch.IsDBNull("District") && record_homechurch.GetRecordList("District").Count > 0) {
                                                    var dist = record_homechurch.GetRecordList("District")[0];
                                                    if(dist.HasField("Name") && !dist.IsDBNull("Name")){
                                                        <tr>
                                                            <td>
                                                                <b>District</b>
                                                            </td>
                                                            <td>
                                                                @dist["Name"]
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                            }
                                        }
                                        @if (record.HasField("CurrentConferenceDropDown") && !record.IsDBNull("CurrentConferenceDropDown")) {
                                            <tr>
                                                <td>
                                                    <b>Conference</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("CurrentConferenceDropDown")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("MoveStatusPerson") && !record.IsDBNull("MoveStatusPerson")) {
                                            <tr>
                                                <td>
                                                    <b>Pastor's Move Preference</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("MoveStatusPerson")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("MoveStatusChurch") && !record.IsDBNull("MoveStatusChurch")) {
                                            <tr>
                                                <td>
                                                    <b>Church's Move Preference</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("MoveStatusChurch")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("MoveStatus") && !record.IsDBNull("MoveStatus")) {
                                            <tr>
                                                <td>
                                                    <b>Cabinet Move Status</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("MoveStatus")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("MoveStatusNotes") && !record.IsDBNull("MoveStatusNotes")) {
                                            <tr>
                                                <td>
                                                    <b>Notes</b>
                                                </td>
                                                <td>
                                                    @record["MoveStatusNotes"]
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("AppointmentFit") && !record.IsDBNull("AppointmentFit")) {
                                            <tr>
                                                <td>
                                                    <b>Appointment Fit</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("AppointmentFit")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("PeopleRank") && !record.IsDBNull("PeopleRank")) {
                                            <tr>
                                                <td>
                                                    <b>Clergy Performance Tier</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("PeopleRank")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("PotentialTier") && !record.IsDBNull("PotentialTier")) {
                                            <tr>
                                                <td>
                                                    <b>Potential Tier</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("PotentialTier")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("KeyCometencies") && !record.IsDBNull("KeyCometencies")) {
                                            <tr>
                                                <td>
                                                    <b>Key Competencies</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("KeyCometencies")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("TheologicalPreferences") && !record.IsDBNull("TheologicalPreferences")) {
                                            <tr>
                                                <td>
                                                    <b>Theological Preferences</b>
                                                </td>
                                                <td>
                                                    @foreach (CategoryFieldItem cat in record.GetCategory("TheologicalPreferences")) {
                                                        @cat.Label
                                                    }
                                                </td>
                                            </tr>
                                        }
                                        @if(record.HasField("ConfidentialNote") && !record.IsDBNull("ConfidentialNote")){
                                            <tr>
                                                <td colspan="2">
                                                    <h5>Confidential Note</h5>
                                                    <div style="max-height:200px;overflow-y:scroll;">@BRT.Raw(record.GetString("ConfidentialNote"))</div>
                                                </td>
                                            </tr>
                                        }
                                        @if (record.HasField("Registrations") && !record.IsDBNull("Registrations") && record.GetRecordList("Registrations").Count > 0) {
                                            <tr>
                                                <td>
                                                    <b>Forms</b>
                                                </td>
                                                <td>
                                                    @foreach (EngineRecord f in record.GetRecordList("Registrations")) {
                                                        <span>@f.GetDateTime("RegisterDate").ToString("d") - </span>
                                                        <a href="https://@EngineCore.CustomerContext.Current.ShortName -reg.brtapp.com/confirm/@f.GetString("AccessKey")" target="_blank">@f.GetString("EventName")</a>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </table>
                                </div>
                            </div>
                            <div class="tabularcontent">
                                @getaffecting(id)
                                @getProjectedAppts(id, churchorperson)
                                @getAppts(id, churchorperson)
                                
                                @getMetricsPerson(id)
                                @*getSalary(id, churchorperson)*@
                                
                                @if(record.HasField("AppointmentToolFiles") && !record.IsDBNull("AppointmentToolFiles") && record.GetFiles("AppointmentToolFiles").Count > 0){
                                    var l = new System.Collections.Generic.List<FileFieldItem>();
                                    foreach(FileFieldItem f in record.GetFiles("AppointmentToolFiles")){
                                        l.Add(f);
                                    }
                                    l.Reverse();
                                    <h5>Appointment Tool Files</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <tr class="bg-light">
                                                <th>File</th>
                                                <th>Description</th>
                                            </tr>
                                            @foreach(FileFieldItem f in l){
                                                <tr>
                                                    <td>
                                                        <a href="@f.Url" target="_blank">
                                                            @if(!String.IsNullOrEmpty(f.Title)){
                                                                <span>@f.Title</span>
                                                            } else {
                                                                <span>@f.Filename</span>
                                                            }
                                                        </a>
                                                    </td>
                                                    <td>
                                                        @if(!String.IsNullOrEmpty(f.Description)){
                                                            <div>@f.Description</div>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </table>
                                    </div>
                                }
                                
                                @if (record.HasField("TrainingCertLog") && !record.IsDBNull("TrainingCertLog") && record.GetRecordList("TrainingCertLog").Count > 0) {
                                    <h5>Trainings, Certifications, Classes</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <tr class="bg-light">
                                                <th>Type</th>
                                                <th>Class Name</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                                <th>Expires On</th>
                                                <th>File(s)</th>
                                            </tr>
                                            @foreach (EngineRecord record_trainingcertlog in record.GetRecordList("TrainingCertLog")) {
                                                <tr>
                                                    <td>
                                                        @if (record_trainingcertlog.HasField("TrainingType") && !record_trainingcertlog.IsDBNull("TrainingType")) {
                                                            foreach (CategoryFieldItem cat in record_trainingcertlog.GetCategory("TrainingType")) {
                                                                <span>@cat.Label</span>
                                                            }
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (record_trainingcertlog.HasField("NamedClass") && !record_trainingcertlog.IsDBNull("NamedClass")) {
                                                            <span>@record_trainingcertlog["NamedClass"]</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (record_trainingcertlog.HasField("CompletionStatus") && !record_trainingcertlog.IsDBNull("CompletionStatus")) {
                                                            foreach (CategoryFieldItem cat in record_trainingcertlog.GetCategory("CompletionStatus")) {
                                                                <span>@cat.Label</span>
                                                            }
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (record_trainingcertlog.HasField("PubDate") && !record_trainingcertlog.IsDBNull("PubDate")) {
                                                            @record_trainingcertlog.GetDateTime("PubDate").ToShortDateString()
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (record_trainingcertlog.HasField("ExpiresOn") && !record_trainingcertlog.IsDBNull("ExpiresOn")) {
                                                            @record_trainingcertlog.GetDateTime("ExpiresOn").ToShortDateString()
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (record_trainingcertlog.HasField("TrainingFile") && !record_trainingcertlog.IsDBNull("TrainingFile")) {
                                                            foreach (FileFieldItem file in record_trainingcertlog.GetFiles("TrainingFile")) {
                                                                <div>
                                                                    <a href="@(file.Url)" target="_blank">@(String.IsNullOrEmpty(file.Title) ? file.Filename : file.Title)</a>
                                                                </div>
                                                            }
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>
                    }
            }
        </div>
    }








@helper currentappointments(){


@BRT.Lister(tableId: "Content", viewId: "Appointments",
    condition: "<IsNull Not=\"true\" Scope=\"Both\" FieldId=\"People.Id\"/>",
    pageSize:10000,
    savedFilters: new[] {"CurrentAppointmentsChDistExt"},
    fields: new[] {"People.FirstName","People.PreferredName","People.LastName","People.ClergyStatus","People.DateStartedInConference","AppointmentPosition","JobTitle","StartDate","EndDate","Church.Name","Church.District.Name","District.Name","ExtensionMinistry","ServiceTime","ExtensionMinistryPositions"},
    template:
@<div>
    <div class="text-center mt-1">@item.Count.ToString("N0") current appointments</div>
    @if (item.Count > 0) {
        <script>
    $(document).ready( function () {
        $('#datatable').dataTable( {
            "paging":         false,
            "info": false,
            dom: 'Bfrtip',
            buttons: [
                'csv', 'excel', 'print'
            ]
            
            
            } );
    } );
    </script>
        
        <table class="cell-border mt-3" id="datatable">
            <thead>
                <tr>
                    <th>Person</th>
                    <th>Position</th>
                    <th>Job</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Church</th>
                    <th>District-level</th>
                    <th>Ext Min NAME</th>
                    <th>Time</th>
                    <th>Non-Church Connection</th>
                </tr>
            </thead>
            <tbody>
            @foreach (EngineRecord record in item) {
                <tr>
                    @* People *@
                    @{string thisDataSort = "";} 
                    @if (!record.IsDBNull("People")) {
                        if (!record.GetRecordList("People")[0].IsDBNull(("LastName"))) {
                           thisDataSort = record.GetRecordList("People")[0].GetString("LastName"); 
                        }
                        if (!record.GetRecordList("People")[0].IsDBNull(("FirstName"))) {
                           thisDataSort += record.GetRecordList("People")[0].GetString("FirstName"); 
                        }
                    }
                    <td data-sort="@thisDataSort">
                        @if (!record.IsDBNull("People")) {
                            foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                @BRT.Raw("<a data-bs-toggle=\"offcanvas\" data-bs-target=\"#snapshotmodal\" href=\"#\" hx-get=\"" + BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_people.Id) +"\" hx-target=\"#snapbody\"  hx-indicator=\"#modalindicator\" class=\"me-1 text-dark\">")
                                if (!record_people.IsDBNull("PreferredName")) {
                                    <span>
                                        @record_people["PreferredName"]
                                    </span>
                                }
                                else if (!record_people.IsDBNull("FirstName")) {
                                    <span>
                                        @record_people["FirstName"]
                                    </span>
                                }
                                @* Last Name *@
                                if (!record_people.IsDBNull("LastName")) {
                                    <span>
                                        @record_people["LastName"]
                                    </span>
                                }
                                @BRT.Raw("</a>")
                            }
                        }
                    </td>

                    @* Appointment Position *@
                    <td>
                        @if (!record.IsDBNull("AppointmentPosition")) {
                            foreach (CategoryFieldItem cat in record.GetCategory("AppointmentPosition")) {
                                <div>
                                    @cat.Label
                                </div>
                            }
                        }
                    </td>

                    @* Job Title (OPTIONAL) *@
                    <td>
                        @if (!record.IsDBNull("JobTitle")) {
                            @record["JobTitle"]
                        }
                    </td>

                    
                    <td data-sort="@if(!record.IsDBNull("StartDate")){@record.GetDateTime("StartDate").ToString("yyyy-MM-dd")}">
                        @if (!record.IsDBNull("StartDate")) {
                            @record.GetDateTime("StartDate").ToShortDateString()
                        }
                    </td>

                    @* End *@
                    <td data-sort="@if(!record.IsDBNull("EndDate")){@record.GetDateTime("EndDate").ToString("yyyy-MM-dd")}">
                        @if (!record.IsDBNull("EndDate")) {
                            @record.GetDateTime("EndDate").ToShortDateString()
                        }
                    </td>

                    @* Church *@
                    <td>
                        @if (!record.IsDBNull("Church")) {
                            foreach (EngineRecord record_church in record.GetRecordList("Church")) {
                                @BRT.Raw("<a hx-swap=\"innerHTML hx-indicator=\"#modalindicator\" scroll:top\" data-bs-toggle=\"offcanvas\" data-bs-target=\"#snapshotmodal\" href=\"#\" hx-get=\"" + BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record_church.Id) +"\" hx-target=\"#snapbody\"  hx-indicator=\"#modalindicator\" class=\"me-1 text-dark\">")
                                @* Church SHORT Name *@
                                if (!record_church.IsDBNull("Name")) {
                                    <span>
                                        @record_church["Name"]
                                    </span>
                                }

                                @* District *@
                                if (!record_church.IsDBNull("District")) {
                                    <span>
                                        @foreach (EngineRecord record_church_district in record_church.GetRecordList("District")) {
                                            <span>
                                                @* District Name *@
                                                @if (!record_church_district.IsDBNull("Name")) {
                                                    <span>
                                                         - @record_church_district["Name"]
                                                    </span>
                                                }
                                            </span>
                                    }
                                    </span>
                                    @BRT.Raw("</a>")
                                }
                            }
                        }
                    </td>

                    @* District *@
                    <td>
                        @if (!record.IsDBNull("District")) {
                            foreach (EngineRecord record_district in record.GetRecordList("District")) {
                                @* District Name *@
                                if (!record_district.IsDBNull("Name")) {
                                    <span>
                                        @record_district["Name"]
                                    </span>
                                }
                            }
                        }
                    </td>

                    @* Ext Ministry NAME *@
                    <td>
                        @if (!record.IsDBNull("ExtensionMinistry")) {
                            @record["ExtensionMinistry"]
                        }
                    </td>

                    @* Service Time *@
                    <td>
                        @if (!record.IsDBNull("ServiceTime")) {
                            foreach (CategoryFieldItem cat in record.GetCategory("ServiceTime")) {
                                <span>
                                    @cat.Label
                                </span>
                            }
                        }
                    </td>

                    @* Non-Church Connection *@
                    <td>
                        @if (!record.IsDBNull("ExtensionMinistryPositions")) {
                            foreach (CategoryFieldItem cat in record.GetCategory("ExtensionMinistryPositions")) {
                                <span>
                                    @cat.Label
                                </span>
                            }
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
        }

</div>
)

}





@*
@helper getchurch(int id){
   <div hx-get="@BRT.SecureUrl("/tempgetter?action=getchurch&id=" + id)" hx-trigger="load"></div> 
}
*@


@helper getAppts(int id, string churchorperson = "church"){
    
        string cond = "";
        
        if(churchorperson == "church"){
            <!--<p>church</p>-->
            cond = "<And><Eq Scope=\"Both\" FieldId=\"Church.Id\" Value=\"" + id + "\"/><IsNull Not=\"true\" Scope=\"Both\" FieldId=\"People.Id\"/></And>";
        } else if(churchorperson == "person"){
            <!--<p>person</p>-->
            cond = "<Eq Scope=\"Both\" FieldId=\"People.Id\" Value=\"" + id + "\"/>";
        } else if(churchorperson == null){
            <!--<p>blank</p>-->
        }
        
        @*
        <!--=================================-->
        <!--CURRENT APPOINTMENTS-->
        <!--=================================-->
        *@
        
        @BRT.Lister(tableId: "Content", viewId: "Appointments",
        condition: cond,
        savedFilters: new[] {"CurrentAppointmentsChDistExt"},
        fields: new[] {"People.FirstName","People.PreferredName","People.LastName","People.ClergyStatus",
        "AppointmentPosition","StartDate","EndDate","ServiceTime",
        "Church.Name","ExtensionMinistryPositions","ExtensionMinistryList.Name","ExtensionMinistry","District.Name"},
        template:
        @<div>
            @if (item.Count > 0) {
                <h5>Current Appointment(s)</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <tr class="bg-light">
                            <th>
                                @if(churchorperson == "person"){
                                    <span>Appointed to</span>
                                } else if(churchorperson == "church"){
                                    <span>Clergy</span>
                                }
                            </th>
                            @if(churchorperson == "church"){
                                <th>Clergy Status</th>
                            }
                            <th>Position</th>
                            <th>Start</th>
                            <th>YUA</th>
                            <th>Service Time</th>
                        </tr>
                        @foreach (EngineRecord record in item) {
                            <tr>
                                <td>
                                    @if(churchorperson == "person"){
                                        if (record.HasField("Church") && !record.IsDBNull("Church") && record.GetRecordList("Church").Count > 0) {
                                            if(!record.GetRecordList("Church")[0].IsDBNull("Name")){
                                                <div>
                                                    <a 
                                                        hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record.GetRecordList("Church")[0].Id)" 
                                                        hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                        _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                    >
                                                        @record.GetRecordList("Church")[0]["Name"]
                                                    </a>
                                                </div>
                                            }
                                        }  
                                        if (record.HasField("ExtensionMinistryPositions") && !record.IsDBNull("ExtensionMinistryPositions")) {
                                            <div>@record.GetFirstCategoryLabel("ExtensionMinistryPositions")</div>
                                        }
                                        if(record.HasField("District") && !record.IsDBNull("District") && record.GetRecordList("District").Count > 0){
                                            <div>@record.GetRecordList("District")[0].GetString("Name")</div>
                                        } 
                                        if (record.HasField("ExtensionMinistryList") && !record.IsDBNull("ExtensionMinistryList") && record.GetRecordList("ExtensionMinistryList").Count > 0){
                                            <div>@record.GetRecordList("ExtensionMinistryList")[0].GetString("Name")</div>
                                        } 
                                        if(record.HasField("ExtensionMinistry") && !record.IsDBNull("ExtensionMinistry")){
                                            <div>@record["ExtensionMinistry"]</div>
                                        }
                                    } else if (churchorperson == "church"){
                                        if (record.HasField("People") && !record.IsDBNull("People") && record.GetRecordList("People").Count > 0) {
                                            foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                                <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                    hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_people.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                >
                                                    @if (record_people.HasField("PreferredName") && !record_people.IsDBNull("PreferredName")) {
                                                        <span>@record_people["PreferredName"]</span>
                                                    } else if (record_people.HasField("FirstName") && !record_people.IsDBNull("FirstName")) {
                                                        <span>@record_people["FirstName"]</span>
                                                    }
                                                    @if (record_people.HasField("LastName") && !record_people.IsDBNull("LastName")) {
                                                        <span>@record_people["LastName"]</span>
                                                    }
                                                </a>
                                            }
                                        }
                                    }
                                </td>
                                @if(churchorperson == "church"){
                                    <td>
                                        @if (record.HasField("People") && !record.IsDBNull("People") && record.GetRecordList("People").Count > 0) {
                                            foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                                if (record_people.HasField("ClergyStatus") && !record_people.IsDBNull("ClergyStatus")) {
                                                    foreach (CategoryFieldItem cat in record_people.GetCategory("ClergyStatus")) {
                                                        <span>@cat.Abbrev</span>
                                                    }
                                                }
                                            }
                                        }
                                    </td>
                                }
                                <td>
                                    @if (record.HasField("AppointmentPosition") && !record.IsDBNull("AppointmentPosition")) {
                                        foreach (CategoryFieldItem cat in record.GetCategory("AppointmentPosition")) {
                                            @cat.Label
                                        }
                                    }
                                </td>
                                <td>
                                    @if (record.HasField("StartDate") && !record.IsDBNull("StartDate")) {
                                        @record.GetDateTime("StartDate").ToShortDateString()
                                    }
                                </td>
                                <td>
                                    @if (record.HasField("StartDate") && !record.IsDBNull("StartDate")) {
                                        int years = DateTime.Now.Year - record.GetDateTime("StartDate").Year;
                                        <span>@years years</span>
                                    } else {
                                        <span>(start date not available)</span>
                                    }
                                </td>
                                <td>
                                    @if (record.HasField("ServiceTime") && !record.IsDBNull("ServiceTime")) {
                                        foreach (CategoryFieldItem cat in record.GetCategory("ServiceTime")) {
                                            @cat.Label
                                        }
                                    }
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            }
        </div>)
        
        @*
        <!--=================================-->
        <!--PAST APPOINTMENTS-->
        <!--=================================-->
        *@
        
        @BRT.Lister(tableId: "Content", viewId: "Appointments",
        condition: cond,
        fields: new[] {"People.FirstName","People.PreferredName","People.LastName","People.ClergyStatus",
        "AppointmentPosition","StartDate","EndDate","ServiceTime",
        "Church.Name","ExtensionMinistryPositions","ExtensionMinistryList.Name","ExtensionMinistry","District.Name"},
        template:
        @<div>
            @if (item.Count > 0) {
                bool go = false;
                bool ret = false;
                foreach (EngineRecord record in item) {
                    if(record.HasField("ExtensionMinistryPositions") && !record.IsDBNull("ExtensionMinistryPositions") && record.GetFirstCategoryLabel("ExtensionMinistryPositions").IndexOf("Retire", StringComparison.OrdinalIgnoreCase) >= 0){
                        ret = true;
                    }
                    if((record.HasField("EndDate") && !record.IsDBNull("EndDate") && record.GetDateTime("EndDate") < DateTime.Today) || ret){
                        go = true;
                        break;
                    }
                }
                if(go){
                    <h5>Past Appointment(s)</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <tr class="bg-light">
                                <th>
                                    @if(churchorperson == "person"){
                                        <span>Appointed to</span>
                                    } else if(churchorperson == "church"){
                                        <span>Clergy</span>
                                    }
                                </th>
                                <th>Position</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Service Time</th>
                            </tr>
                            @foreach (EngineRecord record in item) {
                                bool retired = false;
                                if(record.HasField("ExtensionMinistryPositions") && !record.IsDBNull("ExtensionMinistryPositions") && record.GetFirstCategoryLabel("ExtensionMinistryPositions").IndexOf("Retire", StringComparison.OrdinalIgnoreCase) >= 0){
                                    retired = true;
                                }
                                if((record.HasField("EndDate") && !record.IsDBNull("EndDate") && record.GetDateTime("EndDate") < DateTime.Today) || retired){
                                    <tr>
                                        <td>
                                            @if(churchorperson == "person"){
                                                if (record.HasField("Church") && !record.IsDBNull("Church") && record.GetRecordList("Church").Count > 0) {
                                                        if(!record.GetRecordList("Church")[0].IsDBNull("Name")){
                                                            <div>
                                                                <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                                    hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record.GetRecordList("Church")[0].Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                                >
                                                                    @record.GetRecordList("Church")[0]["Name"]
                                                                </a>
                                                            </div>
                                                        }
                                                    }  
                                                    if (record.HasField("ExtensionMinistryPositions") && !record.IsDBNull("ExtensionMinistryPositions")) {
                                                        <div>@record.GetFirstCategoryLabel("ExtensionMinistryPositions")</div>
                                                    }
                                                    if(record.HasField("District") && !record.IsDBNull("District") && record.GetRecordList("District").Count > 0){
                                                        <div>@record.GetRecordList("District")[0].GetString("Name")</div>
                                                    } 
                                                    if (record.HasField("ExtensionMinistryList") && !record.IsDBNull("ExtensionMinistryList") && record.GetRecordList("ExtensionMinistryList").Count > 0){
                                                        <div>@record.GetRecordList("ExtensionMinistryList")[0].GetString("Name")</div>
                                                    } 
                                                    if(record.HasField("ExtensionMinistry") && !record.IsDBNull("ExtensionMinistry")){
                                                        <div>@record["ExtensionMinistry"]</div>
                                                    }
                                            } else if (churchorperson == "church"){
                                                if (record.HasField("People") && !record.IsDBNull("People") && record.GetRecordList("People").Count > 0) {
                                                    foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                                        <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                            hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_people.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                        >
                                                            @if (record_people.HasField("PreferredName") && !record_people.IsDBNull("PreferredName")) {
                                                                <span>@record_people["PreferredName"]</span>
                                                            } else if (record_people.HasField("FirstName") && !record_people.IsDBNull("FirstName")) {
                                                                <span>@record_people["FirstName"]</span>
                                                            }
                                                            @if (record_people.HasField("LastName") && !record_people.IsDBNull("LastName")) {
                                                                <span>@record_people["LastName"]</span>
                                                            }
                                                        </a>
                                                    }
                                                }
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("AppointmentPosition") && !record.IsDBNull("AppointmentPosition")) {
                                                foreach (CategoryFieldItem cat in record.GetCategory("AppointmentPosition")) {
                                                    @cat.Label
                                                }
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("StartDate") && !record.IsDBNull("StartDate")) {
                                                @record.GetDateTime("StartDate").ToShortDateString()
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("EndDate") && !record.IsDBNull("EndDate")) {
                                                @record.GetDateTime("EndDate").ToShortDateString()
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("ServiceTime") && !record.IsDBNull("ServiceTime")) {
                                                @record.GetDateTime("ServiceTime").ToShortDateString()
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </table>
                    </div>
                }
            }
        </div>)
    }


    @helper getaffecting(int id){
        
        @BRT.Lister(tableId: "Contacts", viewId: "AppointmentToolPeople",
        condition: "<Eq FieldId=\"Id\" Value=\"" + id + "\"/>",
        savedFilters: new[] {"AllPeople", "PendingAppointmentsIntoCurrent"},
        fields: new[] {"Appointments.Church.Name","Appointments.Church.PendingAppointments.AppointmentStatus","Appointments.Church.PendingAppointments.AppointmentPosition","Appointments.Church.PendingAppointments.StartDate","Appointments.Church.PendingAppointments.People.FirstName","Appointments.Church.PendingAppointments.People.PreferredName","Appointments.Church.PendingAppointments.People.LastName"},
        template:
        @<div>
            @if (item.Count > 0) {
                <div class="mb-3 bg-warning bg-opacity-10 p-2">
                    <h5>Affecting appointments coming into their church</h5>
                        @foreach (EngineRecord record in item) {
                            <div>
                                @* Appointments / Lay Supply *@
                                <span>
                                    @if (!record.IsDBNull("Appointments")) {
                                        foreach (EngineRecord record_appointments in record.GetRecordList("Appointments")) {
                                            @* Church (appt tool) *@
                                            if (!record_appointments.IsDBNull("Church")) {
                                                <span>
                                                    @foreach (EngineRecord record_appointments_church in record_appointments.GetRecordList("Church")) {
                                                        <span>
                                                            <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                                hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record_appointments_church.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                            >
                                                                @record_appointments_church["Name"]
                                                            </a>
                                                            </span> <span> has incoming<i class="bi bi-arrow-right"></i></span>
                                                        <span>
                                                            @* Incoming Projected Appointments *@
                                                            @if (!record_appointments_church.IsDBNull("PendingAppointments")) {
                                                                <span>
                                                                    @foreach (EngineRecord record_appointments_church_pendingappointments in record_appointments_church.GetRecordList("PendingAppointments")) {
                                                                        <span>
                                                                           
            
                                                                            @* Appointment Position *@
                                                                            @if (!record_appointments_church_pendingappointments.IsDBNull("AppointmentPosition")) {
                                                                                <span>
                                                                                    @foreach (CategoryFieldItem cat in record_appointments_church_pendingappointments.GetCategory("AppointmentPosition")) {
                                                                                        <span>
                                                                                            @cat.Label
                                                                                        </span>
                                                                                    }
                                                                                </span>
                                                                            }
            
                                                                            @* Start *@
                                                                            @if (!record_appointments_church_pendingappointments.IsDBNull("StartDate")) {
                                                                                <span>
                                                                                    @record_appointments_church_pendingappointments.GetDateTime("StartDate").ToShortDateString()
                                                                                </span>
                                                                            }
            
                                                                            @* People *@
                                                                            @if (!record_appointments_church_pendingappointments.IsDBNull("People")) {
                                                                                <span>
                                                                                    @foreach (EngineRecord record_appointments_church_pendingappointments_people in record_appointments_church_pendingappointments.GetRecordList("People")) {
                                                                                        <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                                                            hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_appointments_church_pendingappointments_people.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                                                        >
                                                                                            
                                                                                            @if (!record_appointments_church_pendingappointments_people.IsDBNull("PreferredName")) {
                                                                                                <span>
                                                                                                    @record_appointments_church_pendingappointments_people["PreferredName"]
                                                                                                </span>
                                                                                            }
                                                                                            else if (!record_appointments_church_pendingappointments_people.IsDBNull("FirstName")) {
                                                                                                <span>
                                                                                                    @record_appointments_church_pendingappointments_people["FirstName"]
                                                                                                </span>
                                                                                            }
            
                                                                                            
            
                                                                                            @* Last Name *@
                                                                                            @if (!record_appointments_church_pendingappointments_people.IsDBNull("LastName")) {
                                                                                                <span>
                                                                                                    @record_appointments_church_pendingappointments_people["LastName"]
                                                                                                </span>
                                                                                            }
                                                                                        </a>
                                                                                }
                                                                                </span>
                                                                            }
                                                                        </span>
                                                                }
                                                                </span>
                                                            }
                                                        </span>
                                                }
                                                </span>
                                            }
                                        }
                                    }
                                </span>
                            </div>
                        }
                        
                </div>
            }
        
        </div>
        )
    
    }

    @helper getProjectedAppts(int id, string churchorperson = "church"){
    
        string cond = "";
        string label = "";
        string tdstyle = "mb-3 bg-success bg-opacity-10 p-2";
        
        if(churchorperson == "church"){
            <!--<p>church</p>-->
            cond = "<Eq Scope=\"Both\" FieldId=\"Church.Id\" Value=\"" + id + "\"/>";
            label = "Incoming Appointments";
            tdstyle = "mb-3 bg-warning bg-opacity-10 p-2";
        } else if(churchorperson == "person"){
            <!--<p>person</p>-->
            cond = "<Eq Scope=\"Both\" FieldId=\"People.Id\" Value=\"" + id + "\"/>";
            label = "Projected Appointments";
            tdstyle = "mb-3 bg-success bg-opacity-10 p-2";
        } else if(churchorperson == null){
            <!--<p>blank</p>-->
        }
        
        @*
        <!--=================================-->
        <!--PROJECTED APPOINTMENTS-->
        <!--=================================-->
        *@
        
        @BRT.Lister(tableId: "Content", viewId: "AppointmentToolPendingAppointments",
        condition: cond,
        //savedFilters: new[] {"Current"},
        fields: new[] {"People.FirstName","People.PreferredName","People.LastName","People.ClergyStatus",
        "AppointmentPosition","StartDate","EndDate","ServiceTime",
        "Church.Name","ExtensionMinistryPositions","ExtensionMinistryList.Name","ExtensionMinistry","District.Name"},
        template:
        @<text>
            @if (item.Count > 0) {
                <div class="@tdstyle">
                    <h5>@label</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered bg-white mb-0">
                            <tr class="bg-light">
                                <th>
                                    @if(churchorperson == "person"){
                                        <span>To be appointed to</span>
                                    } else if(churchorperson == "church"){
                                        <span>Clergy to be appointed</span>
                                    }
                                </th>
                                <th>Clergy Status</th>
                                <th>Position</th>
                                <th>Start Date</th>
                            </tr>
                            @foreach (EngineRecord record in item) {
                                <tr>
                                    <td>
                                        @if(churchorperson == "person"){
                                            if (record.HasField("Church") && !record.IsDBNull("Church") && record.GetRecordList("Church").Count > 0) {
                                                if(!record.GetRecordList("Church")[0].IsDBNull("Name")){
                                                    <div>
                                                        <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                            hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record.GetRecordList("Church")[0].Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                        >
                                                            @record.GetRecordList("Church")[0]["Name"]
                                                        </a>
                                                    </div>
                                                }
                                            }  
                                            if (record.HasField("ExtensionMinistryPositions") && !record.IsDBNull("ExtensionMinistryPositions")) {
                                                <div>@record.GetFirstCategoryLabel("ExtensionMinistryPositions")</div>
                                            }
                                            if(record.HasField("District") && !record.IsDBNull("District") && record.GetRecordList("District").Count > 0){
                                                <div>@record.GetRecordList("District")[0].GetString("Name")</div>
                                            } 
                                            if (record.HasField("ExtensionMinistryList") && !record.IsDBNull("ExtensionMinistryList") && record.GetRecordList("ExtensionMinistryList").Count > 0){
                                                <div>@record.GetRecordList("ExtensionMinistryList")[0].GetString("Name")</div>
                                            } 
                                            if(record.HasField("ExtensionMinistry") && !record.IsDBNull("ExtensionMinistry")){
                                                <div>@record["ExtensionMinistry"]</div>
                                            }
                                        } else if (churchorperson == "church"){
                                            if (record.HasField("People") && !record.IsDBNull("People") && record.GetRecordList("People").Count > 0) {
                                                foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                                    <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                        hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_people.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                    >
                                                        @if (record_people.HasField("PreferredName") && !record_people.IsDBNull("PreferredName")) {
                                                            <span>@record_people["PreferredName"]</span>
                                                        } else if (record_people.HasField("FirstName") && !record_people.IsDBNull("FirstName")) {
                                                            <span>@record_people["FirstName"]</span>
                                                        }
                                                        @if (record_people.HasField("LastName") && !record_people.IsDBNull("LastName")) {
                                                            <span>@record_people["LastName"]</span>
                                                        }
                                                    </a>
                                                }
                                            }
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("People") && !record.IsDBNull("People") && record.GetRecordList("People").Count > 0) {
                                            foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                                if (record_people.HasField("ClergyStatus") && !record_people.IsDBNull("ClergyStatus")) {
                                                    foreach (CategoryFieldItem cat in record_people.GetCategory("ClergyStatus")) {
                                                        <span>@cat.Abbrev</span>
                                                    }
                                                }
                                            }
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("AppointmentPosition") && !record.IsDBNull("AppointmentPosition")) {
                                            foreach (CategoryFieldItem cat in record.GetCategory("AppointmentPosition")) {
                                                @cat.Label
                                            }
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("StartDate") && !record.IsDBNull("StartDate")) {
                                            @record.GetDateTime("StartDate").ToShortDateString()
                                        }
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>
            }
        </text>)
    }
    
    
    @helper getSalary(int id, string churchorperson = "church"){
        
        string cond = "";
        
        if(churchorperson == "church"){
            <!--<p>church</p>-->
            cond = "<And><Eq Scope=\"Both\" FieldId=\"Church.Id\" Value=\"" + id + "\"/><Lt FieldId=\"PubDate\" When=\"now\" /><Or><Gt FieldId=\"EndDate\" When=\"now\" /><IsNull FieldId=\"EndDate\" /></Or></And>";
        } else if(churchorperson == "person"){
            <!--<p>person</p>-->
            cond = "<And><Eq Scope=\"Both\" FieldId=\"People.Id\" Value=\"" + id + "\"/><Lt FieldId=\"PubDate\" When=\"now\" /><Or><Gt FieldId=\"EndDate\" When=\"now\" /><IsNull FieldId=\"EndDate\" /></Or></And>";
        } else if(churchorperson == null){
            <!--<p>blank</p>-->
        }
    
        @BRT.Lister(tableId: "Content", viewId: "Salary",
        condition: cond,
        fields: new[] {"PubDate","EndDate","People.FirstName","People.PreferredName","People.LastName","BaseSalary","HousingAllowance","UtilityExclusion","AccountableReimbursement","CompensationTags","OtherCompensationTags","Church.Name"},
        template:
        @<div>
            @if (item.Count > 0) {
                <h5>Compensation</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <tr class="bg-light">
                            <th>Start</th>
                            <th>End</th>
                            <th>
                                @if(churchorperson == "person"){
                                    <span>Church</span>
                                } else if(churchorperson == "person"){
                                    <span>Clergy</span>
                                }
                            </th>
                            <th>Base</th>
                            <th>Hou Allow</th>
                            @if(churchorperson == "person"){
                                <th>Salary + HA</th>
                            }
                            <th>Util Exc</th>
                            <th>Accou Reimb</th>
                            @if(churchorperson == "person"){
                                <th>Salary + AR</th>
                            }
                            <th>Hou</th>
                            @if(churchorperson == "person"){
                                <th>Salary + HA + AR</th>
                            }
                            @if(churchorperson == "person"){
                                <th>Other Comp Tags</th>
                            }
                        </tr>
                        @foreach (EngineRecord record in item) {
                            <tr>
                                <td>
                                    @if (record.HasField("PubDate") && !record.IsDBNull("PubDate")) {
                                        @record.GetDateTime("PubDate").ToShortDateString()
                                    }
                                </td>
                                <td>
                                    @if (record.HasField("EndDate") && !record.IsDBNull("EndDate")) {
                                        @record.GetDateTime("EndDate").ToShortDateString()
                                    }
                                </td>
                                <td>
                                    @if(churchorperson == "person"){
                                        if (record.HasField("Church") && !record.IsDBNull("Church")) {
                                            foreach (EngineRecord record_church in record.GetRecordList("Church")) {
                                                if (!record_church.IsDBNull("Name")) {
                                                    <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                        hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record_church.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                    >
                                                        @record_church["Name"]
                                                    </a>
                                                }
                                            }
                                        }
                                    } else if (churchorperson == "church"){
                                        if (record.HasField("People") && !record.IsDBNull("People") && record.GetRecordList("People").Count > 0) {
                                            foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                                <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                    hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_people.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                >
                                                    @if (record_people.HasField("PreferredName") && !record_people.IsDBNull("PreferredName")) {
                                                        <span>@record_people["PreferredName"]</span>
                                                    } else if (record_people.HasField("FirstName") && !record_people.IsDBNull("FirstName")) {
                                                        <span>@record_people["FirstName"]</span>
                                                    }
                                                    @if (record_people.HasField("LastName") && !record_people.IsDBNull("LastName")) {
                                                        <span>@record_people["LastName"]</span>
                                                    }
                                                </a>
                                            }
                                        }
                                    }
                                </td>
                                <td>
                                    @if (record.HasField("BaseSalary") && !record.IsDBNull("BaseSalary")) {
                                        @record.GetDouble("BaseSalary").ToString("c0")
                                    }
                                </td>
                                <td>
                                    @if (record.HasField("HousingAllowance") && !record.IsDBNull("HousingAllowance")) {
                                        @record.GetDouble("HousingAllowance").ToString("c0")
                                    }
                                </td>
                                @if(churchorperson == "person"){
                                    <td>
                                        @if (record.HasField("BaseSalary") && record.HasField("HousingAllowance")) {
                                            double amt = record.GetDouble("BaseSalary") + record.GetDouble("HousingAllowance");
                                            <span>@amt.ToString("c0")</span>
                                        }
                                    </td>
                                }
                                <td>
                                    @if (record.HasField("UtilityExclusion") && !record.IsDBNull("UtilityExclusion")) {
                                        @record.GetDouble("UtilityExclusion").ToString("c0")
                                    }
                                </td>
                                <td>
                                    @if (record.HasField("AccountableReimbursement") && !record.IsDBNull("AccountableReimbursement")) {
                                        @record.GetDouble("AccountableReimbursement").ToString("c0")
                                    }
                                </td>
                                @if(churchorperson == "person"){
                                    <td>
                                        @if (record.HasField("BaseSalary") && record.HasField("AccountableReimbursement")) {
                                            double amt = record.GetDouble("BaseSalary") + record.GetDouble("AccountableReimbursement");
                                            <span>@amt.ToString("c0")</span>
                                        }
                                    </td>
                                }
                                <td>
                                    @if (record.HasField("CompensationTags") && !record.IsDBNull("CompensationTags")) {
                                        foreach (CategoryFieldItem cat in record.GetCategory("CompensationTags")) {
                                            @cat.Label
                                        }
                                    }
                                </td>
                                @if(churchorperson == "person"){
                                    <td>
                                        @if (record.HasField("BaseSalary") && record.HasField("HousingAllowance")  && record.HasField("AccountableReimbursement")) {
                                            double amt = record.GetDouble("BaseSalary") + record.GetDouble("HousingAllowance") + record.GetDouble("AccountableReimbursement");
                                            <span>@amt.ToString("c0")</span>
                                        }
                                    </td>
                                }
                                @if(churchorperson == "person"){
                                    <td>
                                        @if (record.HasField("OtherCompensationTags") && !record.IsDBNull("OtherCompensationTags")) {
                                            @record.GetDouble("OtherCompensationTags").ToString("c0")
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </table>
                </div>
            }
        </div>)
    }
    
    @*
    @helper getSalary(int id){
        @BRT.Lister(tableId: "Content", viewId: "Salary",
        condition: "<And><Eq Scope=\"Both\" FieldId=\"Church.Id\" Value=\"" + id + "\"/><Lt FieldId=\"PubDate\" When=\"now\" /><Or><Gt FieldId=\"EndDate\" When=\"now\" /><IsNull FieldId=\"EndDate\" /></Or></And>",
        fields: new[] {"PubDate","People.FirstName","People.PreferredName","People.LastName","BaseSalary","HousingAllowance","UtilityExclusion","AccountableReimbursement","CompensationTags"},
        template:
        @<div>
            @if (item.Count > 0) {
                <h5>Compensation</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <tr class="bg-light">
                            <th>Date</th>
                            <th>Pastor</th>
                            <th>Salary</th>
                            <th>Housing Allowance</th>
                            <th>Utility Exclusion</th>
                            <th>Accountable Reimbursement</th>
                            <th>Compensation Tags</th>
                        </tr>
                    @foreach (EngineRecord record in item) {
                        <tr>
                            <td>
                                @if (record.HasField("PubDate") && !record.IsDBNull("PubDate")) {
                                    @record.GetDateTime("PubDate").ToShortDateString()
                                }
                            </td>
                            <td>
                                @if (record.HasField("People") && !record.IsDBNull("People")) {
                                    foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                        <a _="on click toggle .d-none on #back then go to #modalhead smoothly" href="#" class="text-dark"
                                            hx-get="@BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_people.Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                        >
                                            @if (record_people.HasField("PreferredName") && !record_people.IsDBNull("PreferredName")) {
                                                <span>@record_people["PreferredName"]</span>
                                            } else if (record_people.HasField("FirstName") && !record_people.IsDBNull("FirstName")) {
                                                <span>@record_people["FirstName"]</span>
                                            }
                                            @if (record_people.HasField("LastName") && !record_people.IsDBNull("LastName")) {
                                                <span>@record_people["LastName"]</span>
                                            }
                                        </a>
                                    }
                                }
                            </td>
                            <td>
                                @if (record.HasField("BaseSalary") && !record.IsDBNull("BaseSalary")) {
                                    @record.GetDouble("BaseSalary").ToString("c0")
                                }
                            </td>
                            <td>
                                @if (record.HasField("HousingAllowance") && !record.IsDBNull("HousingAllowance")) {
                                    @record.GetDouble("HousingAllowance").ToString("c0")
                                }
                            </td>
                            <td>
                                @if (record.HasField("UtilityExclusion") && !record.IsDBNull("UtilityExclusion")) {
                                    @record.GetDouble("UtilityExclusion").ToString("c0")
                                }
                            </td>
                            <td>
                                @if (record.HasField("AccountableReimbursement") && !record.IsDBNull("AccountableReimbursement")) {
                                    @record.GetDouble("AccountableReimbursement").ToString("c0")
                                }
                            </td>
                            <td>
                                @if (record.HasField("CompensationTags") && !record.IsDBNull("CompensationTags")) {
                                    foreach (CategoryFieldItem cat in record.GetCategory("CompensationTags")) {
                                        @cat.Label
                                    }
                                }
                            </td>
                        </tr>
                    }
                    </table>
                </div>
            }
        </div>)
    }
    *@
    
    
    @*
    @helper getMetrics(int id, string churchorperson = "church"){
       <div hx-get="@BRT.SecureUrl("/tempgetter?action=getmetrics&churchorperson=" + churchorperson + "&id=" + id)" hx-trigger="load"></div> 
    }
    *@
    
    @helper getMetrics(int id, string churchorperson = "church"){
        
        string cond = "";
        
        if(churchorperson == "church"){
            <!--<p>church</p>-->
            cond = "<Eq Scope=\"Both\" FieldId=\"Church.Id\" Value=\"" + id + "\"/>";
        } else if(churchorperson == "person"){
            <!--<p>person</p>-->
            cond = "<Eq Scope=\"Both\" FieldId=\"People.Id\" Value=\"" + id + "\"/>";
        } else if(churchorperson == null){
            <!--<p>blank</p>-->
        }

        @BRT.Lister(tableId: "Content", viewId: "ChurchPerformanceMetrics",
        condition: cond,
        fields: new[] {"Church.Name","EffectiveYear","AvgWorship","OnlineWorshipAttendance","BeginningMembership","Membership","MembershipGainLoss",
        "SundaySchoolAttendance","ProfessionsOfFaith","ApportionmentAmt","PercentApportionmentsPaid","ApportionmentsPaid"},
        template:
        @<div>
            @if (item.Count > 0) {
                <h5>Apportionments</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <tr class="bg-light">
                            @if(churchorperson == "person"){
                                <th>Church</th>
                            }
                            <th>Year</th>
                            <th>Appt</th>
                            <th>$ Paid</th>
                            <th>Paid %</th>
                            <th>$ Due</th>
                        </tr>
                        @foreach (EngineRecord record in item) {
                            if (record.HasField("EffectiveYear") && !record.IsDBNull("EffectiveYear")) {
                                <tr>
                                    @if(churchorperson == "person"){
                                        <td>
                                            @if (record.HasField("Church") && !record.IsDBNull("Church")) {
                                                if (!record.GetRecordList("Church")[0].IsDBNull("Name")) {
                                                    <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                        hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record.GetRecordList("Church")[0].Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                    >
                                                        @record.GetRecordList("Church")[0]["Name"]
                                                    </a>
                                                }
                                            }
                                        </td>
                                    }
                                    <td>
                                        @record["EffectiveYear"]
                                    </td>
                                    <td>
                                        @if (record.HasField("ApportionmentAmt") && !record.IsDBNull("ApportionmentAmt")) {
                                            @record.GetDouble("ApportionmentAmt").ToString("c0")
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                    <td>
                                        @if ( record.HasField("ApportionmentsPaid") && !record.IsDBNull("ApportionmentsPaid")) {
                                            @record.GetDouble("ApportionmentsPaid").ToString("c0")
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("PercentApportionmentsPaid") && !record.IsDBNull("PercentApportionmentsPaid")) {
                                            <span>@record.GetDouble("PercentApportionmentsPaid").ToString("0")%</span>
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("ApportionmentAmt") && record.HasField("ApportionmentsPaid") && !record.IsDBNull("ApportionmentAmt") && !record.IsDBNull("ApportionmentsPaid")) {
                                            double amtpaid = record.GetDouble("ApportionmentAmt") - record.GetDouble("ApportionmentsPaid");
                                            <span>@amtpaid.ToString("c0")</span>
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </table>
                </div>
                <h5>Metrics</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <tr class="bg-light">
                            @if(churchorperson == "person"){
                                <th>Church</th>
                            }
                            <th>Year</th>
                            <th>Begin Mem</th>
                            <th>Memship</th>
                            <th>POFs</th>
                            <th>+- Members</th>
                            <th>Avg worship</th>
                            <th>Avg online</th>
                        </tr>
                        @foreach (EngineRecord record in item) {
                            if (record.HasField("EffectiveYear") && !record.IsDBNull("EffectiveYear")) {
                                <tr>
                                    @if(churchorperson == "person"){
                                        if (record.HasField("Church") && !record.IsDBNull("Church")) {
                                            if (!record.GetRecordList("Church")[0].IsDBNull("Name")) {
                                                <td>
                                                    <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                        hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record.GetRecordList("Church")[0].Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                    >
                                                        HITHERE @record.GetRecordList("Church")[0]["Name"]
                                                    </a>
                                                </td>
                                            }
                                        }
                                    }
                                    <td>
                                        @record["EffectiveYear"]
                                    </td>
                                    <td>
                                        @if (record.HasField("BeginningMembership") && !record.IsDBNull("BeginningMembership")) {
                                            @record["BeginningMembership"]
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("Membership") && !record.IsDBNull("Membership")) {
                                            @record["Membership"]
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("ProfessionsOfFaith") && !record.IsDBNull("ProfessionsOfFaith")) {
                                            @record["ProfessionsOfFaith"]
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("MembershipGainLoss") && !record.IsDBNull("MembershipGainLoss")) {
                                            @record["MembershipGainLoss"]
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("AvgWorship") && !record.IsDBNull("AvgWorship")) {
                                            @record["AvgWorship"]
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                    <td>
                                        @if (record.HasField("OnlineWorshipAttendance") && !record.IsDBNull("OnlineWorshipAttendance")) {
                                            @record["OnlineWorshipAttendance"]
                                        } else {
                                            <span>n/a</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </table>
                </div>
            }
        </div>)
    }
    
    
    @helper getMetricsPerson(int id){

        @BRT.Lister(tableId: "Content", viewId: "ChurchPerformanceMetrics",
        condition: "<Eq Scope=\"Both\" FieldId=\"Church.Appointments.People.Id\" Value=\"" + id + "\"/>",
        fields: new[] {"Church.Name","EffectiveYear","AvgWorship","OnlineWorshipAttendance","BeginningMembership","Membership","MembershipGainLoss",
        "SundaySchoolAttendance","ProfessionsOfFaith","ApportionmentAmt","PercentApportionmentsPaid","ApportionmentsPaid",
        "Church.Appointments.StartDate","Church.Appointments.EndDate","Church.Appointments.People.FirstName","Church.Appointments.People.LastName"},
        template:
        @<div>
            @if (item.Count > 0) {
                var churchList = new System.Collections.Generic.List<EngineRecord>();
                var yearList = new System.Collections.Generic.List<int>();
                
                foreach (EngineRecord record in item) {
                    if (record.HasField("Church") && !record.IsDBNull("Church") && record.GetRecordList("Church").Count > 0) {
                        if(!churchList.Contains(record.GetRecordList("Church")[0])){
                            churchList.Add(record.GetRecordList("Church")[0]);
                        }
                    }
                }
                if(churchList.Count > 0){
                    foreach(EngineRecord church in churchList){
                        if(church.HasField("Name") && !church.IsDBNull("Name")){
                            <!--<p>@church["Name"]</p>-->
                        }
                        if(church.HasField("Appointments") && !church.IsDBNull("Appointments") && church.GetRecordList("Appointments").Count > 0) {
                            <!--<p>has appts</p>-->
                            int count = 0;
                            foreach(EngineRecord appt in church.GetRecordList("Appointments")){
                                count++;
                                <!--<p>@count</p>-->
                                if (appt.HasField("People") && !appt.IsDBNull("People") && appt.GetRecordList("People").Count > 0) {
                                    <!--<p>has ppl</p>-->
                                    foreach(EngineRecord person in appt.GetRecordList("People")){
                                        <!--<p>@person["FirstName"]</p>-->
                                        if(person.Id == id){
                                            int apptStartDate;
                                            int apptEndDate;
                                            bool openAppt = false;
                                            if (appt.HasField("StartDate") && !appt.IsDBNull("StartDate")) {
                                                apptStartDate = appt.GetDateTime("StartDate").Year;
                                                <!--<p>@apptStartDate</p>-->
                                                if (appt.HasField("EndDate") && !appt.IsDBNull("EndDate")) {
                                                    apptEndDate = appt.GetDateTime("EndDate").Year;
                                                    <!--<p>@apptEndDate</p>-->
                                                    foreach (EngineRecord record in item) {
                                                        if(record.HasField("EffectiveYear") && !record.IsDBNull("EffectiveYear")){
                                                            int effectiveYear = (int)record["EffectiveYear"];
                                                            if (effectiveYear >= apptStartDate && effectiveYear <= apptEndDate){
                                                                <!--<p>print effectiveYear metrics</p>-->
                                                                if(!yearList.Contains(effectiveYear)){
                                                                    yearList.Add(effectiveYear);
                                                                }
                                                            }  
                                                        }
                                                    }
                                                    <!--<p>ended appt</p>-->
                                                } else {
                                                    <!--<p>open appt</p>-->
                                                    int year = apptStartDate;
                                                    int today = DateTime.Today.Year;
                                                    while(year <= today){
                                                        if(!yearList.Contains(year)){
                                                            yearList.Add(year);
                                                        }
                                                        year++;
                                                    }
                                                }
                                            }
                                        } else {
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                foreach(int year in yearList){
                    <!--<p>@year</p>-->
                }
            
                if(yearList.Count > 0){
                    <h5>Apportionments</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <tr class="bg-light">
                                <th>Church</th>
                                <th>Year</th>
                                <th>Appt</th>
                                <th>$ Paid</th>
                                <th>Paid %</th>
                                <th>$ Due</th>
                            </tr>
                            @foreach (EngineRecord record in item) {
                                if (record.HasField("EffectiveYear") && !record.IsDBNull("EffectiveYear") && yearList.Contains(record.GetInteger("EffectiveYear"))) {
                                    <tr>
                                        <td>
                                            @if (record.HasField("Church") && !record.IsDBNull("Church")) {
                                                if (!record.GetRecordList("Church")[0].IsDBNull("Name")) {
                                                    <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                        hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record.GetRecordList("Church")[0].Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                    >
                                                        @record.GetRecordList("Church")[0]["Name"]
                                                    </a>
                                                }
                                            }
                                        </td>
                                        <td>
                                            @record["EffectiveYear"]
                                        </td>
                                        <td>
                                            @if (record.HasField("ApportionmentAmt") && !record.IsDBNull("ApportionmentAmt")) {
                                                @record.GetDouble("ApportionmentAmt").ToString("c0")
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                        <td>
                                            @if ( record.HasField("ApportionmentsPaid") && !record.IsDBNull("ApportionmentsPaid")) {
                                                @record.GetDouble("ApportionmentsPaid").ToString("c0")
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("PercentApportionmentsPaid") && !record.IsDBNull("PercentApportionmentsPaid")) {
                                                <span>@record.GetDouble("PercentApportionmentsPaid").ToString("0")%</span>
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("ApportionmentAmt") && record.HasField("ApportionmentsPaid") && !record.IsDBNull("ApportionmentAmt") && !record.IsDBNull("ApportionmentsPaid")) {
                                                double amtpaid = record.GetDouble("ApportionmentAmt") - record.GetDouble("ApportionmentsPaid");
                                                <span>@amtpaid.ToString("c0")</span>
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </table>
                    </div>
                    <h5>Metrics</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <tr class="bg-light">
                                <th>Church</th>
                                <th>Year</th>
                                <th>Begin Members</th>
                                <th>Membership</th>
                                <th>Professions of faith</th>
                                <th>+- Members</th>
                                <th>Average worship</th>
                                <th>Average online</th>
                            </tr>
                            @foreach (EngineRecord record in item) {
                                if (record.HasField("EffectiveYear") && !record.IsDBNull("EffectiveYear")) {
                                    <tr>
                                        @if (record.HasField("Church") && !record.IsDBNull("Church")) {
                                            if (!record.GetRecordList("Church")[0].IsDBNull("Name")) {
                                                <td>
                                                    <a _="on click remove .d-none from #back then go to #modalhead smoothly" href="#" class="text-dark"
                                                        hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record.GetRecordList("Church")[0].Id)" hx-target="#modalmeat" hx-indicator="#modalindicator" 
                                                    >
                                                        @record.GetRecordList("Church")[0]["Name"]
                                                    </a>
                                                </td>
                                            }
                                        }
                                        <td>
                                            @record["EffectiveYear"]
                                        </td>
                                        <td>
                                            @if (record.HasField("BeginningMembership") && !record.IsDBNull("BeginningMembership")) {
                                                @record["BeginningMembership"]
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("Membership") && !record.IsDBNull("Membership")) {
                                                @record["Membership"]
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("ProfessionsOfFaith") && !record.IsDBNull("ProfessionsOfFaith")) {
                                                @record["ProfessionsOfFaith"]
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("MembershipGainLoss") && !record.IsDBNull("MembershipGainLoss")) {
                                                @record["MembershipGainLoss"]
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("AvgWorship") && !record.IsDBNull("AvgWorship")) {
                                                @record["AvgWorship"]
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                        <td>
                                            @if (record.HasField("OnlineWorshipAttendance") && !record.IsDBNull("OnlineWorshipAttendance")) {
                                                @record["OnlineWorshipAttendance"]
                                            } else {
                                                <span>n/a</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </table>
                    </div>
                }
            }
        </div>)
    }
    
    
    @helper getchurch(int id, string churchorperson = "church"){
        <div class="container-fluid">
            @BRT.Lister(tableId: "Contacts", viewId: "AppointmentToolChurches",
            pageSize:1,
            condition: "<Eq FieldId=\"Id\" Value=\"" + id + "\"/>",
            fields: new[] {"PrimaryImage","Name","District.Name","Parish.Name","Charge.Name","ParsonageTags",
            "TheologicalPreferences","MembershipEngagement","ConfidentialNote","AppointmentToolFiles",
            "Registrations.AccessKey","Registrations.RegisterDate","Registrations.EventName","GCFANumber"},
            template:
            @<text>
                @if (item.Count > 0) {
                    foreach (EngineRecord record in item) {
                        if (!record.IsDBNull("Name")) {
                            <h4 class="p-2 bg-white d-flex justify-content-between align-content-center border" id="modalhead">
                                @record["Name"]
                                <span style="font-size: 60% !important;">
                                    <a href="#" class="d-none btn btn-primary btn-sm" _="on click add .d-none to me" id="back" hx-get="@BRT.SecureUrl("/at2ajax?action=getchurch&id=" + Request.QueryString["id"])" 
                                    hx-target="#snapbody" hx-indicator="#modalindicator"><i class="bi bi-arrow-left"></i> Back
                                        @if (!record.IsDBNull("Name")) {
                                            <span>to @record["Name"]</span>
                                        }
                                    </a>
                                    <a href="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/contacts-appointmenttoolchurches#page=1,@id" 
                                        target="_blank" class="btn btn-secondary btn-sm">
                                        View 
                                        @if (!record.IsDBNull("Name")) {
                                            <span>@record["Name"]</span>
                                        }
                                        in the Console
                                    </a>
                                </span>
                            </h4>
                        }
                    
                        <div id="modalmeat" class="mt-3">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="row">
                                        @{string secondcolumn = "col-xl-12 ";}
                                        @if (record.HasField("PrimaryImage") && !record.IsDBNull("PrimaryImage") && record.GetFiles("PrimaryImage").Count==1) {
                                            secondcolumn = "col-xl-9 ";
                                            <div class="col-xl-3 col-12">
                                            @foreach (FileFieldItem file in record.GetFiles("PrimaryImage")) {
                                                <div>
                                                    @if (file.ContentType.StartsWith("image/")) {
                                                        <a href="@(file.Url)" target="_blank"><img src="@(file.Url)?width=246&height=246&mode=crop" class="p-2 border img-fluid rounded"/></a>
                                                    }
                                                </div>
                                            }
                                            </div>
                                        }
                                        
                                        <div class="@(secondcolumn + "col-12 table-responsive")">
                                            <table class="table table-bordered table-sm">
                                                @if (record.HasField("District") && !record.IsDBNull("District")) {
                                                    <tr>
                                                        <td>
                                                            <b>District</b>
                                                        </td>
                                                        <td>
                                                            @foreach (EngineRecord record_district in record.GetRecordList("District")) {
                                                                if (record_district.HasField("Name") && !record_district.IsDBNull("Name")) {
                                                                    @record_district["Name"]
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                                @if (record.HasField("Charge") && !record.IsDBNull("Charge")) {
                                                    <tr>
                                                        <td>
                                                            <b>Charge</b>
                                                        </td>
                                                        <td>
                                                            @foreach (EngineRecord record_charge in record.GetRecordList("Charge")) {
                                                                @* Charge Name *@
                                                                if (record_charge.HasField("Name") && !record_charge.IsDBNull("Name")) {
                                                                    @record_charge["Name"]
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                                @if (record.HasField("Parish") && !record.IsDBNull("Parish")) {
                                                    <tr>
                                                        <td>
                                                            <b>Parish</b>
                                                        </td>
                                                        <td>
                                                            @foreach (EngineRecord record_parish in record.GetRecordList("Parish")) {
                                                                if (record_parish.HasField("Name") && !record_parish.IsDBNull("Name")) {
                                                                    @record_parish["Name"]
                                                                }
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                                @if (record.HasField("ParsonageTags") && !record.IsDBNull("ParsonageTags")) {
                                                    <tr>
                                                        <td>
                                                            <b>Parsonage</b>
                                                        </td>
                                                        <td>
                                                            @foreach (CategoryFieldItem cat in record.GetCategory("ParsonageTags")) {
                                                                @cat.Label
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                                @if (record.HasField("TheologicalPreferences") && !record.IsDBNull("TheologicalPreferences")) {
                                                    <tr>
                                                        <td>
                                                            <b>Theological Preference</b>
                                                        </td>
                                                        <td>
                                                            @foreach (CategoryFieldItem cat in record.GetCategory("TheologicalPreferences")) {
                                                                @cat.Label
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                                @if (record.HasField("MembershipEngagement") && !record.IsDBNull("MembershipEngagement")) {
                                                    <tr>
                                                        <td>
                                                            <b>Membership Engagement</b>
                                                        </td>
                                                        <td>
                                                            @foreach (CategoryFieldItem cat in record.GetCategory("MembershipEngagement")) {
                                                                @cat.Label
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                                <tr>
                                                    <td colspan="2">
                                                        <a class="text-dark" href="http://www.umdata.org/ChurchProfile.aspx?ChurchID=@record["GCFANumber"]" target="_blank">View prior year stats in UMData.org</a>
                                                    </td>
                                                    
                                                </tr>
                                                @if(record.HasField("ConfidentialNote") && !record.IsDBNull("ConfidentialNote")){
                                                    <tr>
                                                        <td colspan="2">
                                                            <h5>Confidential Note</h5>
                                                            <div style="max-height:200px;overflow-y:scroll;">@BRT.Raw(record.GetString("ConfidentialNote"))</div>
                                                        </td>
                                                    </tr>
                                                }
                                            </table>
                                            @if (record.HasField("AppointmentToolFiles") && !record.IsDBNull("AppointmentToolFiles") && record.GetFiles("AppointmentToolFiles").Count > 0) {
                                                <h5>Files</h5>
                                                <table class="table table-sm table-bordered">
                                                    @foreach (FileFieldItem file in record.GetFiles("AppointmentToolFiles")) {
                                                        <tr>
                                                            <td>
                                                                @if(!String.IsNullOrEmpty(file.Title)){
                                                                    @file.Title
                                                                }else{
                                                                    @file.Filename
                                                                }
                                                                 @if(!String.IsNullOrEmpty(file.Description)){
                                                                    <span>@file.Description</span>
                                                                }
                                                            </td>
                                                            <td>
                                                                <a href="@file.Url" target="_blank" class="text-dark">Open File</a>
                                                            </td>
                                                        </tr>
                                                    }
                                                </table>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tabularcontent">
                                @getProjectedAppts(id, churchorperson)
                                @getAppts(id, churchorperson)
                                @getSalary(id, churchorperson)
                                @getMetrics(id, churchorperson)
                                
                                @if (record.HasField("Registrations") && !record.IsDBNull("Registrations") && record.GetRecordList("Registrations").Count > 0) {
                                    <h5>Forms</h5>
                                    <div class=" table-responsive">
                                        <table class="table table-sm table-bordered">
                                            @foreach (EngineRecord reg in record.GetRecordList("Registrations")) {
                                                <tr>
                                                    <td>
                                                        @if (reg.HasField("RegisterDate") && !reg.IsDBNull("RegisterDate")) {
                                                            @reg.GetDateTime("RegisterDate").ToShortDateString()
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (reg.HasField("EventName") && !reg.IsDBNull("EventName")) {
                                                            <a class="text-dark" href="https://@EngineCore.CustomerContext.Current.ShortName -reg.brtapp.com/confirm/@reg.GetString("AccessKey")" target="_blank">
                                                                @reg["EventName"]
                                                            </a>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>
                    }@* END: foreach (EngineRecord record in item) *@
                }@* END: if (item.Count > 0) *@
            </text>)
        </div>
    }






@helper pendingsimple(){

<script>
    $(document).ready( function () {
    $('#datatable').dataTable( {
        "paging":         false,
        "info": false,
        "order": [[ 1, "desc" ]],
        dom: 'Bfrtip',
        buttons: [
            'csv', 'excel', 'print'
        ]
            
        } );
} );
</script>

    @BRT.Lister(tableId: "Content", viewId: "AppointmentToolPendingAppointments",
    pageSize:10000,
    fields: new[] {"People.FirstName","People.PreferredName","People.LastName","StartDate","AppointmentPosition","Church.Name","Church.District.Name","District.Name","ExtensionMinistry","AppointmentStatus","ServiceTime","OtherServicePercent","Notes","BaseSalary","CompensationTags","HousingAllowance","WhenUpdated"},
    template:
@<div>
    <div class="text-center mt-1">@item.Count.ToString("N0") projected appointments <small class="text-muted">Showing most recently made first</small></div>
    @if (item.Count > 0) {
        
        
        <table class="cell-border mt-3" id="datatable">
            <thead>
                <tr>
                    <th></th>
                    <th>Updated</th>
                    <th>Person</th>
                    <th>Start</th>
                    <th>Position</th>
                    <th>Church</th>
                    <th>Dist (if so)</th>
                    <th>Ext Min</th>
                    <th>Status</th>
                    
                    <th>Time</th>
                    <th>Other time</th>
                    <th>Notes</th>
                    <th>Base sal</th>
                    <th>HOU</th>
                    <th>Allowance</th>
                    
                    
                </tr>
            </thead>
            <tbody>
            @foreach (EngineRecord record in item) {
                <tr>
                    <td><a data-bs-toggle="tooltip" title="Edit this pending appointment" href="https://@EngineCore.CustomerContext.Current.ShortName .brtapp.com/manage/content-appointmenttoolpendingappointments#page=1,@record.Id" target="_blank" class="text-muted">
                            <i class="bi bi-pencil-square"></i></a></td>
                    <td data-sort="@if(!record.IsDBNull("WhenUpdated")){@record.GetDateTime("WhenUpdated").ToString("yyyy-MM-dd")}">
                        <small class="text-muted">@record["WhenUpdated"]</small>
                    </td>
                    
                    
                    @{string thisDataSort = "";} 
                    @if (!record.IsDBNull("People")) {
                        if (!record.GetRecordList("People")[0].IsDBNull(("LastName"))) {
                           thisDataSort = record.GetRecordList("People")[0].GetString("LastName"); 
                        }
                        if (!record.GetRecordList("People")[0].IsDBNull(("FirstName"))) {
                           thisDataSort += record.GetRecordList("People")[0].GetString("FirstName"); 
                        }
                    }
                    <td data-sort="@thisDataSort">
                        @if (!record.IsDBNull("People")) {
                            foreach (EngineRecord record_people in record.GetRecordList("People")) {
                                @BRT.Raw("<a data-bs-toggle=\"offcanvas\" data-bs-target=\"#snapshotmodal\" href=\"#\" hx-get=\"" + BRT.SecureUrl("/at2ajax?action=getperson&id=" + record_people.Id) +"\" hx-target=\"#snapbody\"  hx-indicator=\"#modalindicator\" class=\"me-1 text-dark\">")
                                if (!record_people.IsDBNull("PreferredName")) {
                                    <span>
                                        @record_people["PreferredName"]
                                    </span>
                                }
                                else if (!record_people.IsDBNull("FirstName")) {
                                    <span>
                                        @record_people["FirstName"]
                                    </span>
                                }

                                
                                if (!record_people.IsDBNull("LastName")) {
                                    <span>
                                        @record_people["LastName"]
                                    </span>
                                }
                                @BRT.Raw("</a>")
                            }
                        }
                    </td>

                    
                    <td data-sort="@if(!record.IsDBNull("StartDate")){@record.GetDateTime("StartDate").ToString("yyyy-MM-dd")}">
                        @if (!record.IsDBNull("StartDate")) {
                            @record.GetDateTime("StartDate").ToShortDateString()
                        }
                    </td>

                    
                    <td>
                        @if (!record.IsDBNull("AppointmentPosition")) {
                            foreach (CategoryFieldItem cat in record.GetCategory("AppointmentPosition")) {
                                <span>
                                    @cat.Label
                                </span>
                            }
                        }
                    </td>

                    
                    <td>
                        @if (!record.IsDBNull("Church")) {
                            foreach (EngineRecord record_church in record.GetRecordList("Church")) {
                                @BRT.Raw("<a data-bs-toggle=\"offcanvas\" data-bs-target=\"#snapshotmodal\" href=\"#\" hx-get=\"" + BRT.SecureUrl("/at2ajax?action=getchurch&id=" + record_church.Id) +"\" hx-target=\"#snapbody\"  hx-indicator=\"#modalindicator\" class=\"me-1 text-dark\">")
                                if (!record_church.IsDBNull("Name")) {
                                    <span>
                                        @record_church["Name"]
                                    </span>
                                }
                                
                                <span>
                                @if (!record_church.IsDBNull("District")) {
                                    <span>
                                        @foreach (EngineRecord record_church_district in record_church.GetRecordList("District")) {
                                            <span>
                                                
                                                @if (!record_church_district.IsDBNull("Name")) {
                                                    <span>
                                                        @record_church_district["Name"]
                                                    </span>
                                                }
                                            </span>
                                    }
                                    </span>
                                }
                                </span>
                                @BRT.Raw("</a>")
                            }
                        }
                    </td>

                    
                    <td>
                        @if (!record.IsDBNull("District")) {
                            foreach (EngineRecord record_district in record.GetRecordList("District")) {
                                
                                if (!record_district.IsDBNull("Name")) {
                                    <span>
                                        @record_district["Name"]
                                    </span>
                                }
                            }
                        }
                    </td>

                    @* Ext Ministry NAME *@
                    <td>
                        @if (!record.IsDBNull("ExtensionMinistry")) {
                            @record["ExtensionMinistry"]
                        }
                    </td>

                    @* Appointment Status *@
                    <td>
                        @if (!record.IsDBNull("AppointmentStatus")) {
                            foreach (CategoryFieldItem cat in record.GetCategory("AppointmentStatus")) {
                                <span>
                                    @cat.Label
                                </span>
                            }
                        }
                    </td>
                    
                    
                    
                    @* Service Time *@
                    <td>
                        @if (!record.IsDBNull("ServiceTime")) {
                            foreach (CategoryFieldItem cat in record.GetCategory("ServiceTime")) {
                                <div>
                                    @cat.Label
                                </div>
                            }
                        }
                    </td>

                    @* Other Service Time Percent *@
                    <td>
                        @if (!record.IsDBNull("OtherServicePercent")) {
                            @record["OtherServicePercent"]
                        }
                    </td>

                    @* Notes *@
                    <td>
                        @if (!record.IsDBNull("Notes")) {
                            @record["Notes"]
                        }
                    </td>

                    @* Base Salary *@
                    <td>
                        @if (!record.IsDBNull("BaseSalary")) {
                            @record["BaseSalary"]
                        }
                    </td>

                    @* Housing Tags *@
                    <td>
                        @if (!record.IsDBNull("CompensationTags")) {
                            foreach (CategoryFieldItem cat in record.GetCategory("CompensationTags")) {
                                <div>
                                    @cat.Label
                                </div>
                            }
                        }
                    </td>

                    @* Housing Allowance *@
                    <td>
                        @if (!record.IsDBNull("HousingAllowance")) {
                            @record["HousingAllowance"]
                        }
                    </td>
                    
                    
                    
                    
                    
                </tr>
            }
            </tbody>
        </table>
        }

    </div>)

}




@helper cardrows(){
    
    string table = Request.QueryString["table"];
    string view = Request.QueryString["view"];
    int id=Int32.Parse(Request.QueryString["id"]);
    string condition = "Id=" + id;
    var adapter = EngineAdapter.Create(table,view);
    adapter.AddCondition(condition);
    EngineRecordList result =  adapter.GetList(1,1,true);
    if (result.Count>0) {
        foreach (EngineRecord record in result) {
            <div>
                @for(var i = 0; i < @record.FieldCount; i++){
                    if(record.HasField(record.get_FieldMeta(i).Id) && !record.get_FieldMeta(i).Invisible && !record.IsDBNull(i)){
                        <div class="p-3 rounded bg-white mb-2">
                            <div>
                                <small class="opacity-75 d-inline-block">@record.get_FieldMeta(i).FullName</small>
                            </div>
                            <div>
                                @{
                                    var fieldMeta = record.get_FieldMeta(i);
                                    if (fieldMeta is EngineCore.Meta.CategoryMeta) {
                                    
                                        if(@fieldMeta.Name != "Type" ){
                                            if(!record.IsDBNull(i)){
                                                foreach(CategoryFieldItem catItem in @record.GetCategory(i)) {
                                                    <span class="fs-5" id="br@(record.get_FieldMeta(i).Id)-@(record.Id)">
                                                        @catItem.Label
                                                    </span>
                                                } 
                                            }
                                        }
                                    
                                    } else if (fieldMeta is EngineCore.Meta.RelationshipMeta) {
                                        if(!record.IsDBNull(i)){ 
                                            if (((EngineCore.Meta.RelationshipMeta)fieldMeta).ShowAsTable) {
                                                <div class="rounded bg-light p-2 pb-0">cardrows(record.GetRecordList(i))</div>
                                            } 
                                            else {
                                                var list = record.GetRecordList(i);
                                                <div class="overflow-auto">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                @for(int f = 0; f < list.FieldCount; f++) {
                                                                    <th>@list.get_FieldMeta(f).Name</th>
                                                                }
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                        @foreach(var row in list) {
                                                            <tr>
                                                            @for(int f = 0; f < row.FieldCount; f++){
                                                                <td>@row[f]</td>
                                                            }
                                                            </tr>
                                                        }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            }
                                        }
                                    }
                                    else if(fieldMeta is EngineCore.Meta.FileMeta){
                                        if(record.GetFiles(i).Count>0) {                                                        
                                            for(int f=0;f < @record.GetFiles(i).Count; f++) {
                                            <img src="@record.GetFiles(i)[f].Url?width=300" class="p-2 border" />
                                            }
                                        }
                                     }
                                    else{
                                        if(!record.IsDBNull(i)){
                                            <div class="text-dark fs-5 overflow-auto read-scroll" id="br@(record.get_FieldMeta(i).Id)-@(record.Id)">
                                                <span class="@(record.get_FieldMeta(i).Important?"fw-bolder fs-3":"")">
                                                    @BRT.Raw(record.get_FormattedValue(i))
                                                </span>
                                            </div>
                                        }
                                    }
                                }
                                
                            
                            </div>
                        </div>
                    }
                }
            </div>
        }
    }
}



@functions
{
    
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    public string[] SalaryTotalFields(){   // The fields the customer wants in order to calculate total salary
        if(!@Site.IsDBNull("AppointmentTool2SalaryFields")){
            return Site.GetString("AppointmentTool2SalaryFields").Split(',');
        }
        else{
            return new string[] {"BaseSalary","AccountableReimbursement","UtilityExclusion","EquitableComp"};
        }
    }
    
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    public string[] SalaryTotalFieldsFullyQualified(string comingFrom){   // append the 'coming from field' to get within a list
        string fieldPrefix = "";// It could be Salary or Compensation depeding on church or people
        if(comingFrom=="people"){
            fieldPrefix = "Salary.";
        }
        else{
            fieldPrefix = "CompensationInfo.";
        }
        string[] salFields = SalaryTotalFields();
        for (int i = 0;i < salFields.Length; i++){
            salFields[i] = fieldPrefix + salFields[i];
        }
        return salFields;
    }
    
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    
    public string GetTotalSalary(EngineRecordList salaries){ // you pass in an engine record list of salaries and we'll calculate the total for you based on default total fields or fields the conf has specified.
        bool isCurrentSalary = false;
        decimal TotalSalary  = 0;
        foreach(EngineRecord record_salary in salaries) {
            if(record_salary.HasField("EndDate") && !record_salary.IsDBNull("EndDate") && record_salary.GetDateTime("EndDate") > DateTime.Now) { // checking if it has an end date and if so is it in the future... Else...
                isCurrentSalary = true;
            }
            else if (record_salary.GetDateTime("PubDate") >= Convert.ToDateTime("01/01/" + DateTime.Now.Year.ToString()) && record_salary.GetDateTime("PubDate") <= Convert.ToDateTime("12/31/" + DateTime.Now.Year.ToString())){
                isCurrentSalary = true;
            }
            if(isCurrentSalary){
                foreach(string salaryField in SalaryTotalFields()){
                    if(record_salary.HasField(salaryField) && !record_salary.IsDBNull(salaryField)){
                        TotalSalary += Convert.ToDecimal(record_salary[salaryField]);
                    }
                }
            }
            isCurrentSalary = false;
        }
        
        return "<span at-salary=\"" + TotalSalary + "\">" + TotalSalary.ToString("C0") + "</span>";
        //return TotalSalary.ToString("C0") + "<text _=\"init add .range-" + salaryRange +" to the closest <tr/>\"></text>";
        //return TotalSalary.ToString("C0");
    }
    
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    

    
}












